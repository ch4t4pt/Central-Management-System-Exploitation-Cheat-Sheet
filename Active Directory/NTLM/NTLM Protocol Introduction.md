# NTLM协议介绍

## 本地NTLM认证

用户在登陆时输入密码，系统把用户输入的密码计算成NTLM HASH，然后和本地的%SystemRoot%\System32\config\SAM文件进行比对，若NTLM HASH和SAM比对成功，即登陆成功，否则登陆失败

- 当系统安装在C盘，SAM文件存放在C:\Windows\System32\config\SAM

## 网络NTLM认证

![](../images/Net-NTLM.jpg)

## NTLM HASH

NTLM HASH分为NT HASH和LM HASH

```
Administrator:500:AAD3B435B51404EEAAD3B435B51404EE:31D6CFEOD16AE931B73C59D7E0C089C0:::
```

- LM HASH

```
AAD3B435B51404EEAAD3B435B51404EE
```

- NT HASH

```
31D6CFEOD16AE931B73C59D7E0C089C0
```

LM HASH算法

```
LMHASH1=DES(DOSCHARSET(UPPERCASE(password))1,"KGS!@#$%")
LMHASH2=DES(DOSCHARSET(UPPERCASE(password))2,"KGS!@#$%")
LMHASH=LMHASH1+LMHASH2
```

NT HASH算法

```
NTHASH=MD4(UTF-16-LE(password))
```

## NTLMv1协议

1. 客户端收到服务端的8字节随机挑战值，用C表示
2. 将16字节的LM HASH添加5字节的0，共21字节，分成3个7字节组，分别标记为K1、K2、K3，后续作为DES密钥使用
3. 将K1、K2、K3的每个字节后添加1比特“0”，并在最后补齐比特“0”，变成三个8字节组，成为DES密钥（64比特）
4. 分别将K1、K2、K3作为密钥，对随机挑战值C进行DES加密，并连接成为response1
5. 将16字节的NT HASH添加5字节的0，共21字节，分成3个7字节组，分别标记为K4、K5、K6，后续作为DES密钥使用
6. 分别将K4、K5、K6作为密钥，对随机挑战值C进行DES加密，并连接成为response2
7. response1连接response2，共同组成响应认证报文，也称NTLM NET-HASH

### NTLMv1算法

```
C=8-byte server challenge,random
K1|K2|K3=LM-Hash|5-byte-0
response1=DES(K1,C)|DES(K2,C)|DES(K3,C)
K4|K5|K6=NT-Hash|5-byte-0
response2=DES(K4,C)|DES(K5,C)|DES(K6,C)
response=response1+response2
```

## NTLMv2协议

1. 客户端收到来自服务器的8字节随机挑战值，用SC表示，客户端也会产生8字节的随机数用CC表示
2. 客户端由口令明文、当前时间、CC和服务器的域名共同组成CC*
3. 计算v2-HASH，HASH算法为HMAC-MD5，使用v1版本中的NT HASH做为key，账号名、服务器的域名作为输入值
4. 以v2-HASH为key，HASH算法为HMAC-MD5、SC、CC作为输入值，计算LMv2
5. 以v2-HASH为key，HASH算法为HMAC-MD5、SC、CC*作为输入值，计算NTv2
6. 将LMv2、CC、NTv2、CC*连接，组成NTLMv2的响应报文

### NTLMv2算法

```
SC=8-byte server challenge,random
CC=8-byte server challenge,random
CC*(X,time,CC,domain name)
V2-HASH=HMAC-MD5(NT-HASH,user name,domain name)
LMv2=HMAC-MD5(V2-HASH,SC,CC)
NTv2=HMAC-MD5(v2-HASH,SC,CC*)
response=LMv2|CC|NTv2|CC*
```

